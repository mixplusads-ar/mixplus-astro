---
/**
 * ورودی:
 *  - src: می‌تواند یکی از این‌ها باشد:
 *      1) URL ساده (YouTube/Aparat/…)
 *      2) iframe خام (مثلاً یوتیوب)  ← از داخلش src استخراج می‌کنیم
 *      3) script خام آپارات           ← همان را رندر می‌کنیم
 *  - title?: string
 *  - cover?: string
 */
const { src, title = 'Factory Video', cover = '/media/factory/placeholder.jpg' } = Astro.props;

const raw = (src || '').trim();
const isHtml = raw.startsWith('<');
const isScript = isHtml && /<script\b/i.test(raw);
const isIframe = isHtml && /<iframe\b/i.test(raw);

// اگر iframe خام است، آدرس را جدا کن
let extractedSrc = '';
if (isIframe) {
  const m = raw.match(/src=["']([^"']+)["']/i);
  extractedSrc = m ? m[1] : '';
}

// اگر URL یوتیوب است، پارامترهای مناسب را اضافه کنیم (playsinline, rel=0, modestbranding)
function enhanceYouTube(u) {
  try {
    const url = new URL(u, 'https://dummy.invalid');
    if (!/youtube\.com|youtu\.be/.test(url.href)) return u;
    const embed = url.href.includes('/embed/') ? new URL(url.href) : new URL(`https://www.youtube.com/embed/${url.searchParams.get('v') || ''}`);
    const p = embed.searchParams;
    if (!p.has('playsinline'))     p.set('playsinline', '1');
    if (!p.has('rel'))             p.set('rel', '0');
    if (!p.has('modestbranding'))  p.set('modestbranding', '1');
    return embed.toString();
  } catch { return u; }
}

// تعیین src نهایی iframe (برای حالت URL یا iframe خام)
const finalIframeSrc = !isHtml
  ? enhanceYouTube(raw)
  : (isIframe ? enhanceYouTube(extractedSrc) : '');
---
{isScript ? (
  /* اسکریپت آپارات: خودش ریسپانسیو می‌سازد */
  <div class="video-embed aparat">
    <div class="holder" set:html={raw}></div>
    <noscript><img src={cover} alt={title} /></noscript>
  </div>
) : (
  /* URL یا iframe یوتیوب (یا هر سرویس دیگری) → داخل ظرف 16:9 */
  <div class="video-embed">
    <div class="ratio">
      <iframe
        src={finalIframeSrc || raw}
        title={title}
        allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
        allowfullscreen
        loading="lazy"
        referrerpolicy="no-referrer-when-downgrade"
      ></iframe>
    </div>
    <noscript><img src={cover} alt={title} /></noscript>
  </div>
)}

<style>
.video-embed .ratio{
  position:relative; width:100%; aspect-ratio:16/9;
  background:#000; border-radius:16px; overflow:hidden;
  border:1px solid var(--stroke);
}
/* iframe همیشه کل ظرف را پر کند */
.video-embed iframe{
  position:absolute; inset:0; width:100%; height:100%; border:0; display:block;
}
/* اسکریپت آپارات: تا لود، فضا نگه داشته شود و گوشه‌ها گرد بماند */
.video-embed.aparat .holder{
  min-height: 240px;
  background:#000;
  border:1px solid var(--stroke);
  border-radius:16px;
  overflow:hidden;
}
</style>
