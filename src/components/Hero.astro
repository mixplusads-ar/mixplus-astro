---
const { lang = 'fa' } = Astro.props;
const isFa = lang === 'fa';
const t = (fa, en)=> isFa ? fa : en;
---
<section class="relative h-[86vh] overflow-hidden">
  <video id="heroVideo"
         class="absolute inset-0 w-full h-full object-cover"
         autoplay muted playsinline
         preload="metadata"
         poster="/video/hero-01.jpg">
    <source id="heroSrc" src="/video/hero-01.mp4" type="video/mp4" />
  </video>

  <div class="absolute inset-0 hero-overlay"></div>

  <div class="relative z-10 h-full flex items-center">
    <div class="mx-auto max-w-[1280px] px-6">
      <div class="reveal max-w-2xl">
        <h1 class="text-5xl font-semibold leading-tight mb-4" class:list={[isFa?'font-fa':'font-en']}>
          {t('لوکس و مینیمال، الهام از طراحی ایتالیایی','Minimal. Elegant. Italian-inspired.')}
        </h1>
        <p class="text-lg text-[var(--fg-muted)] mb-6" class:list={[isFa?'font-fa':'font-en']}>
          {t('بیش از ۴۰ سال تجربه در تولید لوازم خانگی: سینک، اجاق، فر توکار و هود.','40+ years crafting sinks, hobs, built-in ovens and hoods.')}
        </p>
        <div class="flex gap-3">
          <a href={`/${lang}/products`} class="btn btn-primary">{t('مشاهده محصولات','Browse Products')}</a>
          <a href={`/${lang}/about`} class="btn btn-outline">{t('دربارهٔ میکس‌پلاس','About MixPlus')}</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ویدیوها + پوسترها
    const list = [
      { src: '/video/hero-01.mp4', poster: '/video/hero-01.jpg' },
      { src: '/video/hero-02.mp4', poster: '/video/hero-02.jpg' },
      { src: '/video/hero-03.mp4', poster: '/video/hero-03.jpg' },
      { src: '/video/hero-04.mp4', poster: '/video/hero-04.jpg' },
    ];

   // Fisher–Yates shuffle => ترتیب جدید در هر بار لود
    const shuffle = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };

    const v = document.getElementById('heroVideo');
    const s = document.getElementById('heroSrc');
    const queue = shuffle(list);
    let idx = 0;

    const setVideo = (item) => {
      if (!v || !s) return;
      v.poster = item.poster;
      s.src = item.src;
      v.load();
    };

    const playSafe = () => {
      const p = v.play?.();
      if (p && p.catch) p.catch(() => {/* اگر Autoplay بلاک شد، پوستر می‌ماند */});
    };

    // شروع
    setVideo(queue[idx]);
    if (v.readyState >= 2) playSafe();
    else v.addEventListener('canplay', playSafe, { once: true });

    // وقتی تمام شد → بعدی
    v.addEventListener('ended', () => {
      idx = (idx + 1) % queue.length;
      setVideo(queue[idx]);
      // اگر خواستی از فریم اول پوستر جدید را ببینی:
      // v.currentTime = 0;
      // و دوباره پخش:
      if (v.readyState >= 2) playSafe();
      else v.addEventListener('canplay', playSafe, { once: true });
    });

    // اگر فایل خراب بود → رد شو و بعدی
    v.addEventListener('error', () => {
      idx = (idx + 1) % queue.length;
      setVideo(queue[idx]);
      if (v.readyState >= 2) playSafe();
      else v.addEventListener('canplay', playSafe, { once: true });
    });
  </script>
</section>
