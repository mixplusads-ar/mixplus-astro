---
import { site } from '../data/site.ts';
const { lang='fa' } = Astro.props;
const t = site[lang];
---
<section class="hero" aria-label="Hero">
  <video id="heroVideo"
    preload="auto"
    playsinline
    muted
    autoplay
    disablepictureinpicture
    controlslist="nodownload noplaybackrate"
  ></video>

  <img id="heroFallback" src="/media/hero/images/hero-01.jpg" alt="Hero" style="display:none" loading="eager"/>

  <div class="overlay"></div>
  <div class="content">
    <div>
      <h1>{t.heroTitle}</h1>
      <p>{t.heroText}</p>
      <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap">
        <a class="btn" href={`/${lang}/products/`}>{t.ctaProducts}</a>
        <a class="btn ghost" href={`/${lang}/about/`}>{t.ctaAbout}</a>
      </div>
    </div>
  </div>
</section>

<script>
/**
 * Robust autoplay:
 * - muted + playsinline set BEFORE loading sources (iOS requirement)
 * - start only when visible (IntersectionObserver)
 * - on rejection -> fallback to image
 * - after each "ended" -> next video from a random queue (no loop)
 */
const sources = [1,2,3,4].sort(()=>Math.random()-0.5).map(n=>`/media/hero/videos/video-0${n}.mp4`);
let idx = 0;

const v = document.getElementById('heroVideo');
const fallback = document.getElementById('heroFallback');

v.muted = true;
v.playsInline = true;
v.autoplay = true;

function setSource(src){
  v.innerHTML = `<source src="${src}" type="video/mp4">`;
  v.load();
}

function showFallback(){
  v.pause();
  v.removeAttribute('src');
  v.innerHTML = '';
  v.style.display='none';
  fallback.style.display='block';
}

async function tryPlay(){
  try{
    const p = v.play();
    if (p && typeof p.then === 'function') await p;
  }catch(e){
    // Autoplay blocked or video error
    showFallback();
  }
}

function playNext(){
  if(idx >= sources.length){ showFallback(); return; }
  setSource(sources[idx++]);
  tryPlay();
}

// start only when hero is visible (helps iOS autoplay policies)
const io = new IntersectionObserver(entries=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      playNext();
      io.disconnect();
    }
  });
},{threshold:.2});
io.observe(document.querySelector('.hero'));

v.addEventListener('ended', playNext);
v.addEventListener('error', showFallback);
</script>
