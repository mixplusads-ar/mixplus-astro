---
import { categories } from '../data/categories.ts';
import { social } from '../data/social.ts';

const { lang = 'fa' } = Astro.props;
const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';
const t = (fa:string, en:string) => (isFa ? fa : en);

// مسیر کاتالوگ بر اساس زبان
const downloadHref = `/public/docs/catalog-${lang}.pdf`.replace('/public','');

// داده های محصولات (ستون راست/چپ مگامنو محصولات)
const roots = [
  { slug: 'hob',  fa: 'اجاق گاز',       en: 'Hob'  },
  { slug: 'sink', fa: 'سینک ظرف‌شویی',  en: 'Sink' },
  { slug: 'hood', fa: 'هود',            en: 'Hood' },
  { slug: 'oven', fa: 'فر',             en: 'Oven' },
];
---
<header class="mx-header" dir={isFa ? 'rtl' : 'ltr'}>
  <div class="container mx-header__in">

    {/** گروهِ سمت راست در فارسی / سمت چپ در انگلیسی (طبق تصویر) */}
    <nav class={`mx-nav ${isFa ? 'mx-slot-3' : 'mx-slot-1'}`} aria-label="primary">
      {isFa ? (
        <>
          <div class="mx-mega mx-mega--products" tabindex="0" aria-haspopup="true">
            <a class="mx-link">{t('محصولات','Products')}</a>
            <div class="mx-bridge" aria-hidden="true"></div>
            <div class="mx-panel">
              <div class="mx-cols">
                <ul class="mx-root">
                  {roots.map(r => (
                    <li><a href={`/${lang}/products/${r.slug}/`}>{isFa ? r.fa : r.en}</a></li>
                  ))}
                </ul>
                <div class="mx-subs">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug:'built-in', nameFa:'فر توکار', nameEn:'Built-in' }];
                    return (
                      <ul>
                        {subs.map(s => (
                          <li><a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{isFa ? s.nameFa : s.nameEn}</a></li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <a class="mx-link" href={`/${lang}/dealers/`}>نمایندگی‌های مجاز</a>
          <span class="mx-pipe">|</span>

          <div class="mx-mega" tabindex="0" aria-haspopup="true">
            <a class="mx-link">خدماتِ پس از فروش</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>فرآیند رسیدگی به شکایات</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>شرایط گارانتی محصولات میکس‌پلاس</a>
              <a href={`/${lang}/after-sales/installation-request/`}>درخواست نصب محصول</a>
              <a href={`/${lang}/after-sales/complaint/`}>شکایت</a>
            </div>
          </div>
        </>
      ) : (
        <>
          <div class="mx-mega mx-mega--products" tabindex="0" aria-haspopup="true">
            <a class="mx-link">Products</a>
            <div class="mx-bridge" aria-hidden="true"></div>
            <div class="mx-panel">
              <div class="mx-cols">
                <ul class="mx-root">
                  {roots.map(r => (
                    <li><a href={`/${lang}/products/${r.slug}/`}>{r.en}</a></li>
                  ))}
                </ul>
                <div class="mx-subs">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug:'built-in', nameFa:'فر توکار', nameEn:'Built-in' }];
                    return (
                      <ul>
                        {subs.map(s => (
                          <li><a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{s.nameEn}</a></li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <a class="mx-link" href={`/${lang}/dealers/`}>Dealers</a>
          <span class="mx-pipe">|</span>
          <div class="mx-mega" tabindex="0" aria-haspopup="true">
            <a class="mx-link">After-Sales</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>Complaint process</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>Warranty terms</a>
              <a href={`/${lang}/after-sales/installation-request/`}>Installation request</a>
              <a href={`/${lang}/after-sales/complaint/`}>Complaint</a>
            </div>
          </div>
          <span class="mx-pipe">|</span>
          <a class="mx-link" href={`/${lang}/about/`}>About-Us</a>
        </>
      )}
    </nav>

    {/** لوگو وسط */}
    <a class="mx-brand mx-slot-2" href={`/${lang}/`} aria-label="MixPlus">
      <brand-logo width="120" height="30"></brand-logo>
    </a>

    {/** گروه مقابل: سمت چپ در فارسی / سمت راست در انگلیسی (طبق تصویر) */}
    <nav class={`mx-nav ${isFa ? 'mx-slot-1' : 'mx-slot-3'}`} aria-label="secondary">
      {isFa ? (
        <>
          <theme-switch class="mx-link" title="Toggle theme"></theme-switch>
          <span class="mx-pipe">|</span>

          <div class="mx-mega mx-mega--tiny" tabindex="0" aria-haspopup="true">
            <a class="mx-link">فارسی ▼</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--tiny">
              <a href={`/${otherLang}/`}>English</a>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <a class="mx-link" href={downloadHref} download>دانلود کاتالوگ</a>

          <span class="mx-pipe">|</span>
          <div class="mx-mega mx-mega--tiny" tabindex="0" aria-haspopup="true">
            <a class="mx-link">#</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--tiny">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <button class="mx-link mx-icon" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24"><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>
        </>
      ) : (
        <>
          <button class="mx-link mx-icon" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24"><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>

          <span class="mx-pipe">|</span>
          <div class="mx-mega mx-mega--tiny" tabindex="0" aria-haspopup="true">
            <a class="mx-link">#</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--tiny">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <a class="mx-link" href={downloadHref} download>Download Catalog</a>

          <span class="mx-pipe">|</span>
          <div class="mx-mega mx-mega--tiny" tabindex="0" aria-haspopup="true">
            <a class="mx-link">English ▼</a>
            <div class="mx-bridge"></div>
            <div class="mx-panel mx-panel--tiny">
              <a href={`/${otherLang}/`}>{isFa ? 'فارسی' : 'Farsi'}</a>
            </div>
          </div>

          <span class="mx-pipe">|</span>
          <theme-switch class="mx-link" title="Toggle theme"></theme-switch>
        </>
      )}
    </nav>
  </div>
</header>

<style>
/* فقط پس‌زمینه هدر: ترنسلوسنت + بلور (بدون تغییر رنگ پنل‌ها) */
.mx-header{
  position:sticky;top:0;z-index:60;border-bottom:1px solid transparent;
  background:rgba(255,255,255,.48);backdrop-filter:blur(10px);
}
html:not(.is-light) .mx-header{background:rgba(16,20,26,.28)}
html.scrolled .mx-header{background:var(--card);border-bottom-color:var(--stroke);backdrop-filter:none}

/* چیدمان سه‌ستونه */
.mx-header__in{display:flex;align-items:center;justify-content:space-between;height:68px}
.mx-slot-1{order:1}.mx-slot-2{order:2}.mx-slot-3{order:3}

.mx-nav{display:flex;align-items:center;gap:16px;white-space:nowrap}
.mx-brand{display:inline-flex;align-items:center;justify-content:center;height:68px}

/* لینک‌ها */
.mx-link{all:unset;cursor:pointer;font-weight:700}
.mx-icon svg{display:block;opacity:.9}
.mx-pipe{opacity:.5}

/* پلِ هاور برای حرکت موس بین تریگر و پنل */
.mx-bridge{position:absolute;left:0;right:0;top:100%;height:12px}

/* پنل‌ها (رنگ فعلی سایت) */
.mx-mega{position:relative}
.mx-panel{
  position:absolute;top:calc(100% + 6px);inset-inline-start:0;
  background:var(--card);border:1px solid var(--stroke);border-radius:14px;
  box-shadow:0 12px 32px rgba(0,0,0,.18);padding:12px;
  opacity:0;transform:translateY(6px);pointer-events:none;
  transition:opacity .18s ease,transform .18s ease;
}
.mx-mega:hover .mx-panel,.mx-mega:focus-within .mx-panel{opacity:1;transform:translateY(0);pointer-events:auto}
.mx-panel--tiny{min-width:140px}
.mx-panel--list{display:flex;flex-direction:column;gap:10px;min-width:280px}

/* مگامنو محصولات: دو ستون؛ فقط هاور = سبز */
.mx-cols{display:flex;gap:12px;align-items:flex-start}
.mx-root{list-style:none;margin:0;padding:6px;border-inline-end:1px solid var(--stroke);min-width:220px}
.mx-root a{display:block;padding:10px 12px;border-radius:10px;color:inherit;font-weight:800}
.mx-root a:hover{color:var(--brand);background:transparent}
.mx-subs>ul{list-style:none;margin:0;padding:6px;min-width:220px}
.mx-subs a{display:block;padding:8px 12px;border-radius:10px;color:inherit}
.mx-subs a:hover{color:var(--brand);background:transparent}
</style>

<script>
/* تم لایت/دارک (با لوگوی مناسب) */
const KEY='mix_theme', html=document.documentElement;
function applyTheme(v){ html.classList.toggle('is-light', v==='light'); }
applyTheme(localStorage.getItem(KEY)||'light');

customElements.define('theme-switch', class extends HTMLElement{
  connectedCallback(){ this.setAttribute('role','button'); this.style.userSelect='none'; this.render();
    this.addEventListener('click', ()=>{ const now=html.classList.contains('is-light')?'dark':'light'; localStorage.setItem(KEY,now); applyTheme(now); this.render(); }); }
  render(){ this.textContent = html.classList.contains('is-light') ? '☾' : '☀︎'; }
});

customElements.define('brand-logo', class extends HTMLElement{
  static get observedAttributes(){ return ['width','height']; }
  connectedCallback(){
    this.img=document.createElement('img'); this.img.alt='MixPlus logo'; this.appendChild(this.img);
    this._size(); this._update();
    const mo=new MutationObserver(()=>this._update()); mo.observe(document.documentElement,{attributes:true,attributeFilter:['class']}); this._mo=mo;
  }
  disconnectedCallback(){ this._mo?.disconnect?.(); }
  attributeChangedCallback(){ this._size(); }
  _size(){ const w=this.getAttribute('width')||'120', h=this.getAttribute('height')||'30'; this.img.width=+w; this.img.height=+h; }
  _update(){ const light=html.classList.contains('is-light'); this.img.src = light ? '/logos/logo-dark.svg' : '/logos/logo.svg'; }
});

/* اسکرول: سالید شدن هدر */
const onScroll=()=>document.documentElement.classList.toggle('scrolled', window.scrollY>6);
onScroll(); addEventListener('scroll', onScroll);

/* Hover-intent ساده تا منو زود بسته نشود */
document.querySelectorAll('.mx-mega').forEach(el=>{
  let t=null; const D=600;
  const open=()=>el.classList.add('open');
  const close=()=>el.classList.remove('open');
  const delay=()=>{ t=setTimeout(close,D); };
  const cancel=()=>{ if(t){clearTimeout(t);t=null;} };

  el.addEventListener('mouseenter',()=>{cancel();open();});
  el.addEventListener('mouseleave',delay);
  el.addEventListener('focusin',()=>{cancel();open();});
  el.addEventListener('focusout',delay);
  el.querySelectorAll('.mx-bridge,.mx-panel').forEach(n=>{
    n.addEventListener('mouseenter',cancel);
    n.addEventListener('mouseleave',delay);
  });
});
</script>
