---
import { categories } from '../data/categories';
import { social } from '../data/social';

const { lang = 'fa' } = Astro.props;
const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';

const downloadHref = `/docs/catalog-${lang}.pdf`;

const roots = [
  { slug: 'hob',  fa: 'اجاق گاز',        en: 'Hob' },
  { slug: 'sink', fa: 'سینک ظرف‌شویی',   en: 'Sink' },
  { slug: 'hood', fa: 'هود',             en: 'Hood' },
  { slug: 'oven', fa: 'فر',              en: 'Oven' },
];
---

<header class={`hdr ${isFa ? 'hdr--fa' : 'hdr--en'}`} dir={isFa ? 'rtl' : 'ltr'}>
  <div class="container hdr__row">

    {/** ناوبری سمت راست لوگو */}
    <nav
      class={`nav nav--primary ${isFa ? 'slot-3 nav--primary-fa' : 'slot-1 nav--primary-en'}`}
      aria-label="Primary navigation"
    >
      {isFa ? (
        <>
          {/** محصولات | نمایندگی‌های مجاز | خدمات پس از فروش (از راست به چپ) */}
          <div class="mega mega--products" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">محصولات</button>
            <div class="bridge"></div>
            <div class="panel panel--products">
              <div class="cols">
                <ul class="roots" id="roots-fa">
                  {roots.map(r => (
                    <li>
                      <a
                        class="root"
                        data-slug={r.slug}
                        href={`/${lang}/products/${r.slug}/`}
                      >
                        {r.fa}
                      </a>
                    </li>
                  ))}
                </ul>
                <div class="subs" id="subs-fa">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug: 'built-in', nameFa: 'فر توکار', nameEn: 'Built-in' }];
                    return (
                      <ul data-for={r.slug}>
                        {subs.map(s => (
                          <li>
                            <a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{s.nameFa}</a>
                          </li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="pipe">|</span>

          <a class="link" href={`/${lang}/dealers/`}>نمایندگی‌های مجاز</a>

          <span class="pipe">|</span>

          <div class="mega" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">خدمات پس از فروش</button>
            <div class="bridge"></div>
            <div class="panel panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>فرآیند رسیدگی به شکایات</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>شرایط گارانتی محصولات میکس‌پلاس</a>
              <a href={`/${lang}/after-sales/installation-request/`}>درخواست نصب محصول</a>
              <a href={`/${lang}/after-sales/complaint/`}>شکایت</a>
            </div>
          </div>
        </>
      ) : (
        <>
          {/** EN: Products | Dealers | After-Sales | About-Us */}
          <div class="mega mega--products" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">Products</button>
            <div class="bridge"></div>
            <div class="panel panel--products">
              <div class="cols">
                <ul class="roots" id="roots-en">
                  {roots.map(r => (
                    <li>
                      <a
                        class="root"
                        data-slug={r.slug}
                        href={`/${lang}/products/${r.slug}/`}
                      >
                        {r.en}
                      </a>
                    </li>
                  ))}
                </ul>
                <div class="subs" id="subs-en">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug: 'built-in', nameFa: 'فر توکار', nameEn: 'Built-in' }];
                    return (
                      <ul data-for={r.slug}>
                        {subs.map(s => (
                          <li>
                            <a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{s.nameEn}</a>
                          </li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/dealers/`}>Dealers</a>

          <span class="pipe">|</span>

          <div class="mega" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">After-Sales</button>
            <div class="bridge"></div>
            <div class="panel panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>Complaint process</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>Warranty terms</a>
              <a href={`/${lang}/after-sales/installation-request/`}>Installation request</a>
              <a href={`/${lang}/after-sales/complaint/`}>Complaint</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/about/`}>About-Us</a>
        </>
      )}
    </nav>

    {/** لوگو */}
    <a class="brand slot-2" href={`/${lang}/`} aria-label="MixPlus">
      <brand-logo width="120" height="32"></brand-logo>
    </a>

    {/** ناوبری سمت چپ لوگو */}
    <nav
      class={`nav nav--secondary ${isFa ? 'slot-1 nav--secondary-fa' : 'slot-3 nav--secondary-en'}`}
      aria-label="Secondary navigation"
    >
      {isFa ? (
        <>
          {/** از راست به چپ: سرچ | # | درباره ما | دانلود کاتالوگ | فارسی ▼ | تم */}

          <theme-switch class="link" title="Toggle theme"></theme-switch>

          <span class="pipe">|</span>

          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">فارسی ▼</button>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={`/${otherLang}/`}>English</a>
            </div>
          </div>

          <span class="pipe">|</span>

          <a class="link" href={downloadHref} download>دانلود کاتالوگ</a>

          <span class="pipe">|</span>

          <a class="link" href={`/${lang}/about/`}>درباره ما</a>

          <span class="pipe">|</span>

          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">#</button>
            <div class="bridge"></div>
            <div class="panel panel--tiny panel--social">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="pipe">|</span>

          <button class="link icon" type="button" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none" />
              <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
          </button>
        </>
      ) : (
        <>
          <button class="link icon" type="button" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none" />
              <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
          </button>

          <span class="pipe">|</span>

          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">#</button>
            <div class="bridge"></div>
            <div class="panel panel--tiny panel--social">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="pipe">|</span>

          <a class="link" href={downloadHref} download>Download Catalog</a>

          <span class="pipe">|</span>

          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <button class="link" type="button">English ▼</button>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={`/${otherLang}/`}>Farsi</a>
            </div>
          </div>

          <span class="pipe">|</span>

          <theme-switch class="link" title="Toggle theme"></theme-switch>
        </>
      )}
    </nav>
  </div>
</header>

<style>
.hdr{
  position:sticky;
  top:0;
  z-index:60;
  border-bottom:1px solid transparent;
  background:rgba(255,255,255,.50);
  backdrop-filter:blur(10px);
}
html:not(.is-light) .hdr{
  background:rgba(16,20,26,.30);
}
html.scrolled .hdr{
  background:var(--card);
  border-bottom-color:var(--stroke);
  backdrop-filter:none;
}

.hdr__row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  height:72px;
}

.slot-1{ order:1; }
.slot-2{ order:2; }
.slot-3{ order:3; }

.nav{
  display:flex;
  align-items:center;
  gap:14px;
  white-space:nowrap;
}

/* فاصله دو طرف لوگو */
.brand{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:72px;
  margin-inline:80px;
}

/* جهت چیدمان برای فارسی و انگلیسی */
.hdr--fa .nav--primary-fa{
  flex-direction:row;          /* این خط مشکل را حل می‌کند: دیگر row-reverse نیست */
}
.hdr--fa .nav--secondary-fa{
  flex-direction:row;
}

/* لینک‌ها */
.link{
  all:unset;
  cursor:pointer;
  font-weight:800;
  color:inherit;
}
.link:hover{
  color:var(--brand);
}
.icon svg{
  display:block;
  opacity:.9;
}
.pipe{
  opacity:.5;
}

/* مگامنو */
.mega{
  position:relative;
}
.bridge{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  height:10px;
}
.panel{
  position:absolute;
  top:calc(100% + 6px);
  inset-inline-start:0;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:16px;
  box-shadow:0 12px 32px rgba(0,0,0,.18);
  padding:12px;
  opacity:0;
  transform:translateY(6px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
}
.hdr[dir="rtl"] .panel{
  inset-inline-start:auto;
  inset-inline-end:0;
}

.mega.open .panel{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}

/* لیست ساده */
.panel--list{
  display:flex;
  flex-direction:column;
  gap:8px;
  min-width:260px;
}

/* منوهای کوچک (زبان / سوشیال) */
.panel--tiny{
  min-width:150px;
}
.panel--tiny.panel--social{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.panel--tiny a{
  display:block;
  padding:4px 8px;
}

.panel a{
  color:inherit;
}
.panel a:hover{
  color:var(--brand);
}

/* مگامنو محصولات */
.panel--products{
  padding:10px;
}
.cols{
  display:flex;
  gap:14px;
  align-items:flex-start;
}
.roots{
  list-style:none;
  margin:0;
  padding:6px;
  border-inline-end:1px solid var(--stroke);
  min-width:230px;
}
.root{
  display:block;
  padding:8px 10px;
  border-radius:10px;
  font-weight:800;
}
.root:hover{
  color:var(--brand);
}
.subs > ul{
  list-style:none;
  margin:0;
  padding:6px;
  min-width:230px;
}
.subs a{
  display:block;
  padding:7px 10px;
  border-radius:10px;
}
.subs a:hover{
  color:var(--brand);
}
</style>

<script>
const THEME_KEY = 'mix_theme';
const html = document.documentElement;

function applyTheme(value) {
  html.classList.toggle('is-light', value === 'light');
}

applyTheme(localStorage.getItem(THEME_KEY) || 'light');

customElements.define('theme-switch', class extends HTMLElement {
  connectedCallback() {
    this.setAttribute('role', 'button');
    this.style.userSelect = 'none';
    this.render();
    this.addEventListener('click', () => {
      const next = html.classList.contains('is-light') ? 'dark' : 'light';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
      this.render();
    });
  }
  render() {
    this.textContent = html.classList.contains('is-light') ? '☾' : '☀︎';
  }
});

customElements.define('brand-logo', class extends HTMLElement {
  static get observedAttributes() { return ['width','height']; }
  connectedCallback() {
    this.img = document.createElement('img');
    this.img.alt = 'MixPlus logo';
    this.appendChild(this.img);
    this._size();
    this._update();
    const mo = new MutationObserver(() => this._update());
    mo.observe(document.documentElement, { attributes:true, attributeFilter:['class'] });
    this._mo = mo;
  }
  disconnectedCallback(){ this._mo?.disconnect?.(); }
  attributeChangedCallback(){ this._size(); }
  _size() {
    const w = this.getAttribute('width') || '120';
    const h = this.getAttribute('height') || '32';
    this.img.width = +w;
    this.img.height = +h;
  }
  _update() {
    const light = html.classList.contains('is-light');
    this.img.src = light ? '/logos/logo-dark.svg' : '/logos/logo.svg';
  }
});

/* اسکرول برای تغییر پس‌زمینه هدر */
function handleScroll(){
  document.documentElement.classList.toggle('scrolled', window.scrollY > 6);
}
handleScroll();
addEventListener('scroll', handleScroll);

/* hover-intent برای مگامنوها */
document.querySelectorAll('.mega').forEach(el => {
  let timer = null;
  const delay = 650;

  const open = () => {
    clearTimeout(timer);
    el.classList.add('open');
  };

  const close = () => {
    timer = setTimeout(() => el.classList.remove('open'), delay);
  };

  el.addEventListener('mouseenter', open);
  el.addEventListener('mouseleave', close);
  el.addEventListener('focusin', open);
  el.addEventListener('focusout', close);

  el.querySelectorAll('.bridge, .panel').forEach(node => {
    node.addEventListener('mouseenter', open);
    node.addEventListener('mouseleave', close);
  });
});

/* سوییچ ساب‌کتگوری‌ها در مگامنو محصولات */
function wireProducts(rootsId, subsId) {
  const roots = document.getElementById(rootsId);
  const subs  = document.getElementById(subsId);
  if (!roots || !subs) return;

  const show = slug => {
    subs.querySelectorAll('ul').forEach(u => {
      u.style.display = (u.dataset.for === slug) ? 'block' : 'none';
    });
  };

  show('hob');

  roots.addEventListener('mouseenter', e => {
    const a = e.target.closest('.root');
    if (a && a.dataset.slug) show(a.dataset.slug);
  }, true);
}

wireProducts('roots-fa', 'subs-fa');
wireProducts('roots-en', 'subs-en');
</script>
