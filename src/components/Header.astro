---
import { site } from '../data/site.ts';
import { categories } from '../data/categories.ts';

const { lang = 'fa' } = Astro.props;
const t = site[lang];
const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';

// Ú†Ù‡Ø§Ø± Ø±ÛŒØ´Û€ Ø§ØµÙ„ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
const roots = [
  { slug: 'hob',   nameFa: 'Ø§Ø¬Ø§Ù‚ Ú¯Ø§Ø²',        nameEn: 'Hob'   },
  { slug: 'sink',  nameFa: 'Ø³ÛŒÙ†Ú© Ø¸Ø±Ùâ€ŒØ´ÙˆÛŒÛŒ',   nameEn: 'Sink'  },
  { slug: 'hood',  nameFa: 'Ù‡ÙˆØ¯',             nameEn: 'Hood'  },
  { slug: 'oven',  nameFa: 'ÙØ± ØªÙˆÚ©Ø§Ø±',         nameEn: 'Oven'  },
];
const txt = (fa: string, en: string) => isFa ? fa : en;
const downloadHref = `/public/docs/catalog-${lang}.pdf`.replace('/public','');
---

<header class="header" dir={isFa ? 'rtl' : 'ltr'}>
  <div class="container header-inner">
    <!-- Ú¯Ø±ÙˆÙ‡ Ø±Ø§Ø³Øª/Ú†Ù¾ -->
    <nav class={`nav ${isFa ? 'nav-right' : 'nav-left'}`} aria-label="primary">
      <!-- Ù…Ø­ØµÙˆÙ„Ø§Øª: Ù„ÛŒØ³Øª Ø¹Ù…ÙˆØ¯ÛŒ Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§ + Ù¾Ù†Ù„ Ø³Ø§Ø¨â€ŒÚ©ØªÚ¯ÙˆØ±ÛŒ Ú©Ù‡ Ø¨Ø§ Ù‡Ø§ÙˆØ± Ø±ÛŒØ´Ù‡ Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      <div class="mega products" data-key="products" tabindex="0" aria-haspopup="true">
        <span class="link like-button">{txt('Ù…Ø­ØµÙˆÙ„Ø§Øª','Products')}</span>
        <div class="mega-panel products">
          <div class="columns">
            <ul class="roots" id="prod-roots">
              {roots.map(r => (
                <li>
                  <a class="root" href={`/${lang}/products/${r.slug}/`} data-slug={r.slug}>
                    {isFa ? r.nameFa : r.nameEn}
                  </a>
                </li>
              ))}
            </ul>

            <div class="subs-wrap" id="prod-subs">
              {roots.map(r => {
                const cat = categories.find(c => c.slug === r.slug);
                const subs = cat?.subs ?? [];
                return (
                  <ul class="subs" data-for={r.slug}>
                    {subs.length
                      ? subs.map(s => (
                          <li><a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{isFa ? s.nameFa : s.nameEn}</a></li>
                        ))
                      : <li class="empty">{txt('Ø¨Ø¯ÙˆÙ† Ø²ÛŒØ±â€ŒØ¯Ø³ØªÙ‡','No subcategories')}</li>
                    }
                  </ul>
                );
              })}
            </div>
          </div>
        </div>
      </div>

      <span class="pipe">|</span>

      <a class="link like-button" href={`/${lang}/dealers/`}>{txt('Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²','Dealers')}</a>

      <span class="pipe">|</span>

      <div class="mega aftersales" data-key="aftersales" tabindex="0" aria-haspopup="true">
        <span class="link like-button">{txt('Ø®Ø¯Ù…Ø§ØªÙ Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´','After-sales')}</span>
        <div class="mega-panel">
          <div class="mega-list">
            <a href={`/${lang}/after-sales/complaint-process/`}>{txt('ÙØ±Ø¢ÛŒÙ†Ø¯ Ø±Ø³ÛŒØ¯Ú¯ÛŒ Ø¨Ù‡ Ø´Ú©Ø§ÛŒØ§Øª','Complaint process')}</a>
            <a href={`/${lang}/after-sales/warranty-terms/`}>{txt('Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÛŒÚ©Ø³â€ŒÙ¾Ù„Ø§Ø³','Warranty terms')}</a>
            <a href={`/${lang}/after-sales/installation-request/`}>{txt('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ØµØ¨ Ù…Ø­ØµÙˆÙ„','Installation request')}</a>
            <a href={`/${lang}/after-sales/complaint/`}>{txt('Ø´Ú©Ø§ÛŒØª','Complaint')}</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Ù„ÙˆÚ¯Ùˆ ÙˆØ³Ø· -->
    <a class="brand" href={`/${lang}/`} aria-label="MixPlus">
      <brand-logo width="120" height="30"></brand-logo>
    </a>

    <!-- Ú¯Ø±ÙˆÙ‡ Ù…Ù‚Ø§Ø¨Ù„ -->
    <nav class={`nav ${isFa ? 'nav-left' : 'nav-right'}`} aria-label="secondary">
      <!-- Ø¬Ø³ØªØ¬Ùˆ (Ø§Ø³ØªØ§Ø¨) -->
      <button class="link like-button" aria-label={txt('Ø¬Ø³ØªØ¬Ùˆ','Search')} title={txt('Ø¬Ø³ØªØ¬Ùˆ','Search')} disabled>ğŸ”</button>

      <span class="pipe">|</span>

      <!-- Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ (#) -->
      <div class="mega" data-key="social" tabindex="0" aria-haspopup="true">
        <span class="link like-button">#</span>
        <div class="mega-panel">
          <div class="mega-list socials">
            <a href={site.social.instagram} target="_blank" rel="noopener">Instagram</a>
            <a href={site.social.aparat}   target="_blank" rel="noopener">Aparat</a>
            <a href={site.social.youtube}  target="_blank" rel="noopener">YouTube</a>
            <a href={site.social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
            <a href={site.social.telegram} target="_blank" rel="noopener">Telegram</a>
          </div>
        </div>
      </div>

      <span class="pipe">|</span>

      <a class="link like-button" href={`/${lang}/about/`}>{txt('Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§','About')}</a>

      <span class="pipe">|</span>

      <a class="link like-button" href={downloadHref} download>{txt('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§ØªØ§Ù„ÙˆÚ¯','Download catalog')}</a>

      <span class="pipe">|</span>

      <!-- ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù† Ø¨Ø§ Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ† ØªÚ©â€ŒØ¢ÛŒØªÙ…ÛŒ -->
      <div class="mega lang" tabindex="0" aria-haspopup="true">
        <span class="link like-button lang-switch">
          {isFa ? 'ÙØ§Ø±Ø³ÛŒ' : 'English'}
          <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </span>
        <div class="mega-panel tiny">
          <div class="mega-list">
            <a href={`/${otherLang}/`}>{isFa ? 'English' : 'ÙØ§Ø±Ø³ÛŒ'}</a>
          </div>
        </div>
      </div>

      <span class="pipe">|</span>

      <!-- Ø³ÙˆÛŒÛŒÚ†Ø± ØªÙ… -->
      <theme-switch class="link like-button" title={txt('ØªØºÛŒÛŒØ± ØªÙ…','Toggle theme')}></theme-switch>
    </nav>
  </div>
</header>

<style>
.header { position: sticky; top: 0; z-index: 60; border-bottom: 1px solid transparent; }
.header-inner { display:flex; align-items:center; justify-content:space-between; height:68px; }
.brand { display:inline-flex; align-items:center; justify-content:center; height:68px; }

.nav { display:flex; align-items:center; gap: 16px; white-space:nowrap; }
.nav-right { order: 1; }
.brand     { order: 2; }
.nav-left  { order: 3; }

.link.like-button { all: unset; cursor:pointer; font-weight:600; padding:6px 0; }
.link[disabled]{ opacity:.45; cursor:not-allowed; }
.pipe { opacity:.5; user-select:none; }

/* Ù¾Ù†Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ú¯Ø§Ù…Ù†Ùˆ */
.mega { position: relative; }
.mega-panel{
  position:absolute; top: calc(100% + 14px);
  inset-inline-start: 0;
  background: var(--card);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  box-shadow: 0 12px 32px rgba(0,0,0,.18);
  padding: 12px;
  opacity: 0; transform: translateY(6px);
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
}
.mega:focus-within .mega-panel,
.mega:hover .mega-panel { opacity:1; transform:translateY(0); pointer-events:auto; }
.mega-panel.tiny{ min-width: 160px; }

.mega-list{ display:flex; flex-direction:column; gap:10px; min-width: 280px; }
.mega-list.socials a::before{ content:'#'; opacity:.6; margin-inline-end:6px; }

/* Ù…Ø­ØµÙˆÙ„Ø§Øª: Ù„ÛŒØ³Øª Ø±ÛŒØ´Ù‡ + Ù¾Ù†Ù„ Ø³Ø§Ø¨ */
.mega-panel.products{ padding: 10px; }
.columns{ display:flex; gap:12px; }
.roots{ list-style:none; margin:0; padding:6px; border-inline-end:1px solid var(--stroke); width: var(--rootw, max-content); }
.roots .root{ display:block; padding:10px 12px; border-radius:10px; font-weight:800; position:relative; }
.roots .root[aria-current="true"]{ color: var(--brand); }
.subs-wrap{ padding:6px; width: var(--subw, max-content); }
.subs{ display:none; list-style:none; margin:0; padding:6px; min-width: max-content; }
.subs.is-active{ display:block; }
.subs li a{ display:block; padding:8px 12px; border-radius:10px; }
.subs li a:hover,.roots .root:hover{ background: var(--stroke); }
.subs .empty{ opacity:.6; padding:8px 12px; }

/* Ø²Ø¨Ø§Ù†: ÙÙ„Ø´ Ø±ÛŒØ² */
.lang-switch svg{ margin-inline-start:6px; vertical-align:-2px; opacity:.75 }

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
@media (max-width: 980px){
  .header-inner{ gap:8px; }
  .mega-panel{ min-width: 260px; }
  .mega-panel.products .columns{ flex-direction: column; }
  .roots{ border:none; }
}
</style>

<script>
/* Ø³ÙˆÛŒÛŒÚ†Ø± ØªÙ… */
const KEY = 'mix_theme';
const html = document.documentElement;
function applyTheme(v){ html.classList.toggle('is-light', v === 'light'); }
applyTheme(localStorage.getItem(KEY) || 'light');

customElements.define('theme-switch', class extends HTMLElement{
  connectedCallback(){
    this.setAttribute('role','button'); this.setAttribute('aria-label','Toggle theme');
    this.style.userSelect='none'; this.render();
    this.addEventListener('click', () => {
      const now = html.classList.contains('is-light') ? 'dark' : 'light';
      localStorage.setItem(KEY, now); applyTheme(now); this.render();
    });
  }
  render(){ this.textContent = html.classList.contains('is-light') ? 'â˜¾' : 'â˜€ï¸'; }
});

/* Ù„ÙˆÚ¯ÙˆÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ø¨Ù‡ ØªÙ… */
customElements.define('brand-logo', class extends HTMLElement{
  static get observedAttributes(){ return ['width','height']; }
  connectedCallback(){
    this.img = document.createElement('img'); this.img.alt = 'MixPlus logo'; this.appendChild(this.img);
    this._applySize(); this.updateSrc();
    const mo = new MutationObserver(()=>this.updateSrc());
    mo.observe(document.documentElement,{attributes:true,attributeFilter:['class']}); this._mo = mo;
  }
  disconnectedCallback(){ this._mo?.disconnect?.(); }
  attributeChangedCallback(){ this._applySize(); }
  _applySize(){ const w=this.getAttribute('width')||'120', h=this.getAttribute('height')||'30'; this.img.width=+w; this.img.height=+h; }
  updateSrc(){ const isLight = document.documentElement.classList.contains('is-light'); this.img.src = isLight ? '/logos/logo-dark.svg' : '/logos/logo.svg'; }
});

/* Ú©Ù„Ø§Ø³ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ÛŒØ¯ Ø´Ø¯Ù† Ù‡Ø¯Ø± */
const onScroll = () => document.documentElement.classList.toggle('scrolled', window.scrollY > 6);
onScroll(); window.addEventListener('scroll', onScroll);

/* --- Hover Intent Ùˆ Ù…Ù†Ø·Ù‚ Ù…Ø­ØµÙˆÙ„Ø§Øª --- */
// ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ‡â€ŒØ´Ø¯Ù†ØŒ ØªØ§ Ú©Ø§Ø±Ø¨Ø± ÙØ±ØµØª Ø­Ø±Ú©Øª Ø¨Ù‡ Ù¾Ù†Ù„ Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
document.querySelectorAll('.mega').forEach((el) => {
  let hideTimer = null;
  const open = ()=>{ el.classList.add('open'); };
  const close = ()=>{ el.classList.remove('open'); };
  const delayClose = ()=>{ hideTimer = setTimeout(close, 280); };
  const cancelClose = ()=>{ if(hideTimer){clearTimeout(hideTimer);hideTimer=null;} };

  el.addEventListener('mouseenter', cancelClose);
  el.addEventListener('mouseleave', delayClose);
  el.addEventListener('focusin', cancelClose);
  el.addEventListener('focusout', delayClose);
});

// Ù…Ø­ØµÙˆÙ„Ø§Øª: Ù„ÛŒØ³Øª Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§ Ùˆ Ù¾Ù†Ù„ Ø³Ø§Ø¨
const rootsEl = document.getElementById('prod-roots');
const subsWrap = document.getElementById('prod-subs');
if (rootsEl && subsWrap){
  // Ø§Ú©ØªÛŒÙˆ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø§ÙˆÙ„ÛŒÙ† Ø±ÛŒØ´Ù‡
  let activeSlug = rootsEl.querySelector('.root')?.getAttribute('data-slug') || 'hob';
  function activate(slug){
    activeSlug = slug;
    rootsEl.querySelectorAll('.root').forEach(a => a.setAttribute('aria-current', a.getAttribute('data-slug')===slug ? 'true':'false'));
    subsWrap.querySelectorAll('.subs').forEach(ul => ul.classList.toggle('is-active', ul.getAttribute('data-for')===slug));
  }
  rootsEl.addEventListener('mouseenter', e => {
    const a = e.target.closest('.root'); if(a) activate(a.getAttribute('data-slug'));
  }, true);
  rootsEl.addEventListener('focusin', e => {
    const a = e.target.closest('.root'); if(a) activate(a.getAttribute('data-slug'));
  });

  // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ = Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆØ§ (fit Ø¯Ø± Ø³Ø·Ø­ Ù‡Ø± Ø³ØªÙˆÙ†)
  function fitColumns(){
    // Ø±ÛŒØ´Ù‡â€ŒÙ‡Ø§
    let rw = 0;
    rootsEl.querySelectorAll('.root').forEach(a => rw = Math.max(rw, a.offsetWidth));
    // Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† Ø³Ø§Ø¨ Ø¯Ø± Ù‡Ù…Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§
    let sw = 0;
    subsWrap.querySelectorAll('.subs').forEach(ul => ul.querySelectorAll('a').forEach(a => sw = Math.max(sw, a.offsetWidth)));
    const panel = rootsEl.closest('.mega-panel');
    panel?.style.setProperty('--rootw', (rw + 16) + 'px'); // padding compensation
    panel?.style.setProperty('--subw', (sw + 16) + 'px');
  }

  // ÙˆÙ‚ØªÛŒ Ù¾Ù†Ù„ Ø¨Ø§Ø² Ø´Ø¯ØŒ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ú©Ù†
  const prodMega = document.querySelector('.mega.products');
  const obs = new MutationObserver(()=> fitColumns());
  obs.observe(prodMega, { attributes:true, attributeFilter:['class'] });

  // Ø¨Ø§Ø± Ø§ÙˆÙ„
  activate(activeSlug);
  setTimeout(fitColumns, 0);
}
</script>
