---
import { site } from '../data/site.ts';
import { categories } from '../data/categories.ts';

const { lang = 'fa' } = Astro.props;
const t = site[lang];
const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';

// Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ´Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ú¯Ø§Ù…Ù†Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª (Ú†Ù‡Ø§Ø± Ø³ØªÙˆÙ†)
const roots = [
  { slug: 'hob',   nameFa: 'Ø§Ø¬Ø§Ù‚ Ú¯Ø§Ø²',        nameEn: 'Hob'   },
  { slug: 'sink',  nameFa: 'Ø³ÛŒÙ†Ú© Ø¸Ø±Ùâ€ŒØ´ÙˆÛŒÛŒ',   nameEn: 'Sink'  },
  { slug: 'hood',  nameFa: 'Ù‡ÙˆØ¯',             nameEn: 'Hood'  },
  { slug: 'oven',  nameFa: 'ÙØ±',               nameEn: 'Oven'  },
];

const txt = (fa: string, en: string) => isFa ? fa : en;
const downloadHref = `/public/docs/catalog-${lang}.pdf`.replace('/public','');
---

<header class={`header`} dir={isFa ? 'rtl' : 'ltr'}>
  <div class="container header-inner">

    <!-- Ú¯Ø±ÙˆÙ‡ Ø±Ø§Ø³Øª/Ú†Ù¾ Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† -->
    <nav class={`nav ${isFa ? 'nav-right' : 'nav-left'}`} aria-label="primary">
      <!-- Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù…Ú¯Ø§Ù…Ù†Ùˆ) -->
      <div class="mega" data-key="products" tabindex="0" aria-haspopup="true">
        <span class="link like-button">{txt('Ù…Ø­ØµÙˆÙ„Ø§Øª','Products')}</span>
        <div class="mega-panel">
          <div class="mega-grid">
            {roots.map(r => {
              const cat = categories.find(c => c.slug === r.slug);
              const hasSubs = !!cat?.subs?.length;
              return (
                <div class="mega-col">
                  <a class="root" href={`/${lang}/products/${r.slug}/`}>{isFa ? r.nameFa : r.nameEn}</a>
                  {hasSubs && (
                    <ul class="subs">
                      {cat!.subs!.map(s => (
                        <li><a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{isFa ? s.nameFa : s.nameEn}</a></li>
                      ))}
                    </ul>
                  )}
                </div>
              );
            })}
          </div>
        </div>
      </div>

      <span class="pipe">|</span>

      <!-- Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ -->
      <a class="link like-button" href={`/${lang}/dealers/`}>{txt('Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²','Dealers')}</a>

      <span class="pipe">|</span>

      <!-- Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´ (Ù…Ú¯Ø§Ù…Ù†Ùˆ) -->
      <div class="mega" data-key="aftersales" tabindex="0" aria-haspopup="true">
        <span class="link like-button">{txt('Ø®Ø¯Ù…Ø§ØªÙ Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´','After-sales')}</span>
        <div class="mega-panel">
          <div class="mega-list">
            <a href={`/${lang}/after-sales/complaint-process/`}>{txt('ÙØ±Ø¢ÛŒÙ†Ø¯ Ø±Ø³ÛŒØ¯Ú¯ÛŒ Ø¨Ù‡ Ø´Ú©Ø§ÛŒØ§Øª','Complaint process')}</a>
            <a href={`/${lang}/after-sales/warranty-terms/`}>{txt('Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÛŒÚ©Ø³â€ŒÙ¾Ù„Ø§Ø³','Warranty terms')}</a>
            <a href={`/${lang}/after-sales/installation-request/`}>{txt('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ØµØ¨ Ù…Ø­ØµÙˆÙ„','Installation request')}</a>
            <a href={`/${lang}/after-sales/complaint/`}>{txt('Ø´Ú©Ø§ÛŒØª','Complaint')}</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Ù„ÙˆÚ¯Ùˆ ÙˆØ³Ø· (Ø³ÙˆÛŒÛŒÚ† Ø®ÙˆØ¯Ú©Ø§Ø± ØªÙ…) -->
    <a class="brand" href={`/${lang}/`} aria-label="MixPlus">
      <brand-logo width="120" height="30"></brand-logo>
    </a>

    <!-- Ú¯Ø±ÙˆÙ‡ Ù…Ù‚Ø§Ø¨Ù„ -->
    <nav class={`nav ${isFa ? 'nav-left' : 'nav-right'}`} aria-label="secondary">

      <!-- Ø¬Ø³ØªØ¬Ùˆ (Ø§Ø³ØªØ§Ø¨) -->
      <button class="link like-button" aria-label={txt('Ø¬Ø³ØªØ¬Ùˆ','Search')} title={txt('Ø¬Ø³ØªØ¬Ùˆ','Search')} disabled>ğŸ”</button>

      <span class="pipe">|</span>

      <!-- Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ (#) -->
      <div class="mega" data-key="social" tabindex="0" aria-haspopup="true">
        <span class="link like-button">#</span>
        <div class="mega-panel">
          <div class="mega-list socials">
            <a href={site.social.instagram} target="_blank" rel="noopener">Instagram</a>
            <a href={site.social.aparat}   target="_blank" rel="noopener">Aparat</a>
            <a href={site.social.youtube}  target="_blank" rel="noopener">YouTube</a>
            <a href={site.social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
            <a href={site.social.telegram} target="_blank" rel="noopener">Telegram</a>
          </div>
        </div>
      </div>

      <span class="pipe">|</span>

      <!-- Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ -->
      <a class="link like-button" href={`/${lang}/about/`}>{txt('Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§','About')}</a>

      <span class="pipe">|</span>

      <!-- Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§ØªØ§Ù„ÙˆÚ¯ -->
      <a class="link like-button" href={downloadHref} download>{txt('Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§ØªØ§Ù„ÙˆÚ¯','Download catalog')}</a>

      <span class="pipe">|</span>

      <!-- ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù† (Ø¨Ø§ ÙÙ„Ø´ Ú©ÙˆÚ†Ú©) -->
      <a class="link like-button lang-switch" href={`/${otherLang}/`} aria-label="Switch language">
        {isFa ? 'ÙØ§Ø±Ø³ÛŒ' : 'English'}
        <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </a>

      <span class="pipe">|</span>

      <!-- Ø³ÙˆÛŒÛŒÚ†Ø± ØªÙ… (Ù…Ø§Ù‡/Ø®ÙˆØ±Ø´ÛŒØ¯ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„) -->
      <theme-switch class="link like-button" title={txt('ØªØºÛŒÛŒØ± ØªÙ…','Toggle theme')}></theme-switch>
    </nav>
  </div>
</header>

<style>
/* Ø³Ø§Ø®ØªØ§Ø± Ùˆ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ */
.header { position: sticky; top: 0; z-index: 60; border-bottom: 1px solid transparent; }
.header-inner { display:flex; align-items:center; justify-content:space-between; height:68px; }
.brand { display:inline-flex; align-items:center; justify-content:center; height:68px; }

.nav { display:flex; align-items:center; gap: 16px; white-space:nowrap; }
.nav-right { order: 1; }
.brand     { order: 2; }
.nav-left  { order: 3; }

.link.like-button { all: unset; cursor: pointer; font-weight: 600; padding: 6px 0; }
.link[disabled] { opacity:.45; cursor:not-allowed; }
.pipe { opacity:.5; user-select:none; }

/* Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù‡Ø¯Ø±: Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ù†ÛŒÙ…Ù‡â€ŒØ´ÙØ§Ù + Ø¨Ù„ÙˆØ± / Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„: Ø³Ø§Ù„ÛŒØ¯ */
.header {
  background: rgba(255,255,255,.50);
  backdrop-filter: blur(10px);
}
html:not(.is-light) .header { background: rgba(18,24,33,.20); }

html.scrolled .header {
  background: var(--card);
  border-bottom-color: var(--stroke);
  backdrop-filter: none; /* Ø¨Ø¯ÙˆÙ† Ø¨Ù„ÙˆØ± */
}

/* Ù„ÙˆÚ¯Ùˆ Ù‡Ù…ÛŒØ´Ù‡ ÙˆØ³Ø· Ùˆ Ø¹Ù…ÙˆØ¯Ø§Ù‹ Ø³Ù†ØªØ± */
.brand img { display:block; }

/* Ù…Ú¯Ø§Ù…Ù†Ùˆ */
.mega { position: relative; }
.mega-panel {
  position: absolute; top: calc(100% + 14px);
  inset-inline-start: 0; /* Ø¯Ø± RTL/LTR Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢ÛŒÙ†Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
  background: var(--card);
  border: 1px solid var(--stroke);
  border-radius: 14px;
  box-shadow: 0 12px 32px rgba(0,0,0,.18);
  padding: 14px;
  min-width: 340px;
  opacity: 0; transform: translateY(6px);
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
}
.mega:focus-within .mega-panel,
.mega:hover .mega-panel { opacity:1; transform: translateY(0); pointer-events: auto; }

.mega-grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 14px; }
.mega-col .root { display:block; font-weight:800; margin-bottom:8px; }
.mega-col .subs { list-style: none; padding: 0; margin: 0; }
.mega-col .subs li { margin: 6px 0; }
.mega-col .subs a { opacity:.9; }

.mega-list { display:flex; flex-direction: column; gap: 10px; min-width: 280px; }
.mega-list.socials a::before { content:'#'; opacity:.6; margin-inline-end:6px; }

/* Ø²Ø¨Ø§Ù†: ÙÙ„Ø´ Ø±ÛŒØ² */
.lang-switch svg{ margin-inline-start:6px; vertical-align:-2px; opacity:.75 }

/* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ Ø³Ø§Ø¯Ù‡ */
@media (max-width: 980px){
  .header-inner { gap: 8px; }
  .mega-panel { min-width: 260px; }
  .mega-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
}
</style>

<script>
/* Ø³ÙˆÛŒÛŒÚ†Ø± ØªÙ… */
const KEY = 'mix_theme';
const html = document.documentElement;
function applyTheme(v){ html.classList.toggle('is-light', v === 'light'); }
applyTheme(localStorage.getItem(KEY) || 'light');

customElements.define('theme-switch', class extends HTMLElement{
  connectedCallback(){
    this.setAttribute('role','button');
    this.setAttribute('aria-label','Toggle theme');
    this.style.userSelect='none';
    this.render();
    this.addEventListener('click', () => {
      const now = html.classList.contains('is-light') ? 'dark' : 'light';
      localStorage.setItem(KEY, now);
      applyTheme(now);
      this.render();
    });
  }
  render(){
    const isLight = html.classList.contains('is-light');
    // Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„: Ù…Ø§Ù‡/Ø®ÙˆØ±Ø´ÛŒØ¯
    this.textContent = isLight ? 'â˜¾' : 'â˜€ï¸';
  }
});

/* Ù„ÙˆÚ¯ÙˆÛŒ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ Ø¨Ù‡ ØªÙ… */
customElements.define('brand-logo', class extends HTMLElement{
  static get observedAttributes(){ return ['width','height']; }
  connectedCallback(){
    this.img = document.createElement('img');
    this.img.alt = 'MixPlus logo';
    this.appendChild(this.img);
    this._applySize();
    this.updateSrc();
    const mo = new MutationObserver(()=>this.updateSrc());
    mo.observe(document.documentElement, { attributes:true, attributeFilter:['class'] });
    this._mo = mo;
  }
  disconnectedCallback(){ this._mo?.disconnect?.(); }
  attributeChangedCallback(){ this._applySize(); }
  _applySize(){
    const w = this.getAttribute('width') || '120';
    const h = this.getAttribute('height') || '30';
    this.img.width = +w; this.img.height = +h;
  }
  updateSrc(){
    const isLight = document.documentElement.classList.contains('is-light');
    this.img.src = isLight ? '/logos/logo-dark.svg' : '/logos/logo.svg';
  }
});

/* Ø§ÙØ²ÙˆØ¯Ù†/Ø­Ø°Ù Ú©Ù„Ø§Ø³ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ÛŒØ¯ Ø´Ø¯Ù† Ù‡Ø¯Ø± */
const onScroll = () => document.documentElement.classList.toggle('scrolled', window.scrollY > 6);
onScroll(); window.addEventListener('scroll', onScroll);

/* hover-intent Ø®ÛŒÙ„ÛŒ Ø³Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ø¨Ø³ØªÙ† Ø¢Ø±Ø§Ù… Ù…Ú¯Ø§Ù…Ù†ÙˆÙ‡Ø§ */
document.querySelectorAll('.mega').forEach((el) => {
  let hideTimer = null;
  el.addEventListener('mouseleave', () => {
    hideTimer = setTimeout(() => {
      (el as HTMLElement).blur();
    }, 220);
  });
  el.addEventListener('mouseenter', () => {
    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
  });
});
</script>
