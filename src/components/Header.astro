---
import { categories } from "../data/categories";
import { social } from "../data/social";

interface Props {
  lang: "fa" | "en";
}

const { lang = "fa" } = Astro.props;
const isFa = lang === "fa";

const t = (fa: string, en: string) => (isFa ? fa : en);
---

<header
  class={`mix-header ${isFa ? "mix-header--rtl" : "mix-header--ltr"}`}
  data-header
>
  <div class="mix-header__inner">
    <!-- ناوبری سمت راست/چپ (بسته به زبان) -->
    <nav class={`mix-header__nav mix-header__nav--primary`}>
      {isFa ? (
        <>
          <button
            class="mix-header__link mix-header__link--has-mega"
            data-mega-trigger="products"
            type="button"
          >
            محصولات
          </button>
          <span class="mix-header__divider">|</span>

          <a href="/fa/dealers/" class="mix-header__link">
            نمایندگی‌های مجاز
          </a>
          <span class="mix-header__divider">|</span>

          <button
            class="mix-header__link mix-header__link--has-mega"
            data-mega-trigger="after-sales"
            type="button"
          >
            خدمات پس از فروش
          </button>
        </>
      ) : (
        <>
          <button
            class="mix-header__link mix-header__link--has-mega"
            data-mega-trigger="products"
            type="button"
          >
            Products
          </button>
          <span class="mix-header__divider">|</span>

          <a href="/en/dealers/" class="mix-header__link">
            Dealers
          </a>
          <span class="mix-header__divider">|</span>

          <button
            class="mix-header__link mix-header__link--has-mega"
            data-mega-trigger="after-sales"
            type="button"
          >
            After-Sales
          </button>
          <span class="mix-header__divider">|</span>

          <a href="/en/about/" class="mix-header__link">
            About-Us
          </a>
        </>
      )}
    </nav>

    <!-- لوگو وسط -->
    <a
      href={isFa ? "/fa/" : "/en/"}
      class="mix-header__logo-link"
      aria-label="MixPlus Home"
    >
      <img
        class="mix-header__logo"
        src="/logos/logo.svg"
        alt="MixPlus"
        loading="lazy"
        data-logo-main
      />
      <img
        class="mix-header__logo mix-header__logo--dark"
        src="/logos/logo-dark.svg"
        alt="MixPlus"
        loading="lazy"
        data-logo-alt
      />
    </a>

    <!-- ناوبری سمت مقابل -->
    <nav class="mix-header__nav mix-header__nav--secondary">
      {isFa ? (
        <>
          <!-- جستجو -->
          <button
            class="mix-header__icon-btn"
            type="button"
            aria-label="جستجو"
          >
            <span class="mix-header__icon mix-header__icon--search" />
          </button>
          <span class="mix-header__divider">|</span>

          <!-- منوی سوشیال (#) -->
          <div class="mix-header__dropdown" data-menu="social">
            <button
              type="button"
              class="mix-header__link"
              data-dropdown-trigger="social"
            >
              #
            </button>
            <div class="mix-dropdown mix-dropdown--social" data-dropdown-panel>
              <ul class="mix-dropdown__list">
                {social.map((item) => (
                  <li class="mix-dropdown__item">
                    <a
                      href={item.href}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="mix-dropdown__link"
                    >
                      {item.label}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
          <span class="mix-header__divider">|</span>

          <a href="/fa/about/" class="mix-header__link">
            درباره ما
          </a>
          <span class="mix-header__divider">|</span>

          <a href="/docs/catalog-fa.pdf" class="mix-header__link" target="_blank">
            دانلود کاتالوگ
          </a>
          <span class="mix-header__divider">|</span>

          <!-- تغییر زبان -->
          <div class="mix-header__dropdown" data-menu="lang">
            <button
              type="button"
              class="mix-header__link mix-header__link--lang"
              data-dropdown-trigger="lang"
            >
              فارسی
              <span class="mix-header__lang-caret">▼</span>
            </button>
            <div class="mix-dropdown" data-dropdown-panel>
              <button
                type="button"
                class="mix-dropdown__link"
                data-lang-switch="en"
              >
                English
              </button>
            </div>
          </div>
          <span class="mix-header__divider">|</span>

          <!-- تغییر تم -->
          <button
            type="button"
            class="mix-header__icon-btn"
            aria-label="تغییر تم"
            data-theme-toggle
          >
            <span class="mix-header__icon mix-header__icon--theme" />
          </button>
        </>
      ) : (
        <>
          <!-- جستجو -->
          <button
            class="mix-header__icon-btn"
            type="button"
            aria-label="Search"
          >
            <span class="mix-header__icon mix-header__icon--search" />
          </button>
          <span class="mix-header__divider">|</span>

          <!-- منوی سوشیال (#) -->
          <div class="mix-header__dropdown" data-menu="social">
            <button
              type="button"
              class="mix-header__link"
              data-dropdown-trigger="social"
            >
              #
            </button>
            <div class="mix-dropdown mix-dropdown--social" data-dropdown-panel>
              <ul class="mix-dropdown__list">
                {social.map((item) => (
                  <li class="mix-dropdown__item">
                    <a
                      href={item.href}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="mix-dropdown__link"
                    >
                      {item.label}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
          <span class="mix-header__divider">|</span>

          <a
            href="/docs/catalog-en.pdf"
            class="mix-header__link"
            target="_blank"
          >
            Download Catalog
          </a>
          <span class="mix-header__divider">|</span>

          <!-- تغییر زبان -->
          <div class="mix-header__dropdown" data-menu="lang">
            <button
              type="button"
              class="mix-header__link mix-header__link--lang"
              data-dropdown-trigger="lang"
            >
              English
              <span class="mix-header__lang-caret">▼</span>
            </button>
            <div class="mix-dropdown" data-dropdown-panel>
              <button
                type="button"
                class="mix-dropdown__link"
                data-lang-switch="fa"
              >
                فارسی
              </button>
            </div>
          </div>
          <span class="mix-header__divider">|</span>

          <!-- تغییر تم -->
          <button
            type="button"
            class="mix-header__icon-btn"
            aria-label="Toggle theme"
            data-theme-toggle
          >
            <span class="mix-header__icon mix-header__icon--theme" />
          </button>
        </>
      )}
    </nav>
  </div>

  <!-- مگامنو محصولات -->
  <div
    class={`mix-mega mix-mega--products ${isFa ? "mix-mega--rtl" : "mix-mega--ltr"}`}
    data-mega-panel="products"
  >
    <div class="mix-mega__inner">
      <div class="mix-mega__root-col">
        {categories.map((cat, index) => (
          <button
            type="button"
            class={`mix-mega__root ${
              index === 0 ? "is-active" : ""
            }`}
            data-cat-root={cat.slug}
          >
            {isFa ? cat.nameFa : cat.nameEn}
          </button>
        ))}
      </div>
      <div class="mix-mega__sub-col">
        {categories.map((cat, index) => (
          <div
            class={`mix-mega__sub-group ${
              index === 0 ? "is-active" : ""
            }`}
            data-cat-subs={cat.slug}
          >
            {cat.subs ? (
              <ul class="mix-mega__sub-list">
                {cat.subs.map((sub) => (
                  <li class="mix-mega__sub-item">
                    <a
                      class="mix-mega__sub-link"
                      href={`/${isFa ? "fa" : "en"}/products/${cat.slug}/${sub.slug}/`}
                    >
                      {isFa ? sub.nameFa : sub.nameEn}
                    </a>
                  </li>
                ))}
              </ul>
            ) : (
              <a
                class="mix-mega__sub-link"
                href={`/${isFa ? "fa" : "en"}/products/${cat.slug}/`}
              >
                {isFa ? cat.nameFa : cat.nameEn}
              </a>
            )}
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- مگامنو خدمات پس از فروش -->
  <div
    class={`mix-mega mix-mega--after ${
      isFa ? "mix-mega--rtl" : "mix-mega--ltr"
    }`}
    data-mega-panel="after-sales"
  >
    <div class="mix-mega__inner mix-mega__inner--single">
      <ul class="mix-mega__sub-list">
        {isFa ? (
          <>
            <li class="mix-mega__sub-item">
              <a
                href="/fa/after-sales/complaint-process/"
                class="mix-mega__sub-link"
              >
                فرآیند رسیدگی به شکایات
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/fa/after-sales/warranty-terms/"
                class="mix-mega__sub-link"
              >
                شرایط گارانتی محصولات میکس پلاس
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/fa/after-sales/installation-request/"
                class="mix-mega__sub-link"
              >
                درخواست نصب محصول
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/fa/after-sales/complaint/"
                class="mix-mega__sub-link"
              >
                شکایت
              </a>
            </li>
          </>
        ) : (
          <>
            <li class="mix-mega__sub-item">
              <a
                href="/en/after-sales/complaint-process/"
                class="mix-mega__sub-link"
              >
                Complaint process
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/en/after-sales/warranty-terms/"
                class="mix-mega__sub-link"
              >
                Warranty terms
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/en/after-sales/installation-request/"
                class="mix-mega__sub-link"
              >
                Installation request
              </a>
            </li>
            <li class="mix-mega__sub-item">
              <a
                href="/en/after-sales/complaint/"
                class="mix-mega__sub-link"
              >
                Complaint
              </a>
            </li>
          </>
        )}
      </ul>
    </div>
  </div>
</header>

<script type="module">
  // ---------------------------
  // Theme handling (کل سایت)
  // ---------------------------
  const STORAGE_KEY = "mix_theme";
  const docEl = document.documentElement;

  function applyTheme(theme) {
    if (theme !== "dark" && theme !== "light") theme = "light";
    docEl.dataset.theme = theme;
    localStorage.setItem(STORAGE_KEY, theme);

    const logoMain = document.querySelector("[data-logo-main]");
    const logoAlt = document.querySelector("[data-logo-alt]");
    if (!logoMain || !logoAlt) return;

    if (theme === "dark") {
      (logoMain as HTMLImageElement).style.display = "none";
      (logoAlt as HTMLImageElement).style.display = "block";
    } else {
      (logoMain as HTMLImageElement).style.display = "block";
      (logoAlt as HTMLImageElement).style.display = "none";
    }
  }

  const storedTheme = localStorage.getItem(STORAGE_KEY);
  const prefersDark = window.matchMedia &&
    window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(storedTheme || (prefersDark ? "dark" : "light"));

  const themeBtn = document.querySelector("[data-theme-toggle]");
  themeBtn?.addEventListener("click", () => {
    const current = docEl.dataset.theme === "dark" ? "dark" : "light";
    applyTheme(current === "dark" ? "light" : "dark");
  });

  // ---------------------------
  // Lang switch
  // ---------------------------
  document
    .querySelectorAll("[data-lang-switch]")
    .forEach((btn) => {
      btn.addEventListener("click", () => {
        const to = (btn as HTMLElement).dataset.langSwitch;
        if (to === "fa") {
          window.location.href = "/fa/";
        } else if (to === "en") {
          window.location.href = "/en/";
        }
      });
    });

  // ---------------------------
  // Dropdowns (social / lang)
  // ---------------------------
  function setupDropdown(name) {
    const trigger = document.querySelector(
      `[data-dropdown-trigger="${name}"]`
    );
    const panel = (trigger?.parentElement)?.querySelector(
      "[data-dropdown-panel]"
    ) as HTMLElement | null;

    if (!trigger || !panel) return;

    let open = false;

    function setOpen(v) {
      open = v;
      panel.style.opacity = open ? "1" : "0";
      panel.style.pointerEvents = open ? "auto" : "none";
    }

    trigger.addEventListener("click", (e) => {
      e.stopPropagation();
      setOpen(!open);
    });

    document.addEventListener("click", () => setOpen(false));
  }

  setupDropdown("social");
  setupDropdown("lang");

  // ---------------------------
  // Mega menus + hover intent
  // ---------------------------
  function setupMega(name) {
    const trigger = document.querySelector(
      `[data-mega-trigger="${name}"]`
    );
    const panel = document.querySelector(
      `[data-mega-panel="${name}"]`
    ) as HTMLElement | null;

    if (!trigger || !panel) return;

    let open = false;
    let timer;

    function setOpen(v) {
      open = v;
      panel.classList.toggle("is-open", open);
      (trigger as HTMLElement).classList.toggle("is-active", open);
    }

    function scheduleOpen(v) {
      clearTimeout(timer);
      timer = setTimeout(() => setOpen(v), 220);
    }

    trigger.addEventListener("mouseenter", () => scheduleOpen(true));
    trigger.addEventListener("mouseleave", () => scheduleOpen(false));
    panel.addEventListener("mouseenter", () => scheduleOpen(true));
    panel.addEventListener("mouseleave", () => scheduleOpen(false));

    trigger.addEventListener("click", (e) => {
      e.preventDefault();
      setOpen(!open);
    });
  }

  setupMega("products");
  setupMega("after-sales");

  // ---------------------------
  // Mega products: root/sub
  // ---------------------------
  const rootButtons = Array.from(
    document.querySelectorAll("[data-cat-root]")
  ) as HTMLButtonElement[];

  rootButtons.forEach((btn) => {
    btn.addEventListener("mouseenter", () => {
      const slug = btn.dataset.catRoot;
      if (!slug) return;

      rootButtons.forEach((b) => b.classList.remove("is-active"));

      const groups = document.querySelectorAll("[data-cat-subs]");
      groups.forEach((g) => {
        const el = g as HTMLElement;
        el.classList.toggle("is-active", el.dataset.catSubs === slug);
      });

      btn.classList.add("is-active");
    });
  });
</script>

<style>
  .mix-header {
    position: sticky;
    top: 0;
    z-index: 40;
    backdrop-filter: blur(14px);
    background: transparent;
  }

  .mix-header--rtl {
    direction: rtl;
  }

  .mix-header--ltr {
    direction: ltr;
  }

  .mix-header__inner {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0.75rem 2.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 3.5rem;
  }

  .mix-header__nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
  }

  .mix-header__nav--primary {
    flex: 1;
    justify-content: flex-start;
  }

  .mix-header__nav--secondary {
    flex: 1;
    justify-content: flex-end;
  }

  .mix-header__logo-link {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4rem;
  }

  .mix-header__logo {
    height: 34px;
    display: block;
  }

  .mix-header__logo--dark {
    display: none;
  }

  .mix-header__link {
    font-size: 0.95rem;
    border: none;
    background: none;
    cursor: pointer;
    padding: 0 0.15rem;
    line-height: 1;
    color: var(--header-fg, #111);
    transition: color 0.18s ease;
  }

  .mix-header__link--has-mega {
    font-weight: 600;
  }

  .mix-header__link--lang {
    display: inline-flex;
    align-items: center;
    gap: 0.15rem;
  }

  .mix-header__lang-caret {
    font-size: 0.6rem;
  }

  .mix-header__divider {
    opacity: 0.35;
    font-size: 0.9rem;
  }

  .mix-header__icon-btn {
    border: none;
    background: none;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .mix-header__icon {
    display: inline-block;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    position: relative;
  }

  .mix-header__icon--search::before,
  .mix-header__icon--theme::before {
    content: "";
    position: absolute;
    inset: 0;
    mask-repeat: no-repeat;
    mask-position: center;
    mask-size: 16px 16px;
    background-color: var(--header-fg, #111);
  }

  .mix-header__icon--search::before {
    mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Ccircle cx='11' cy='11' r='6' stroke='black' stroke-width='2'/%3E%3Cpath d='M16 16L20 20' stroke='black' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
  }

  .mix-header__icon--theme::before {
    mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21 12.79A9 9 0 0111.21 3 7 7 0 0012 17a7 7 0 009-4.21z' fill='black'/%3E%3C/svg%3E");
  }

  .mix-header__link:hover,
  .mix-header__link.is-active {
    color: var(--brand, #0fa99c);
  }

  .mix-header__icon-btn:hover .mix-header__icon::before {
    background-color: var(--brand, #0fa99c);
  }

  /* DROPDOWN (social/lang) */
  .mix-header__dropdown {
    position: relative;
  }

  .mix-dropdown {
    position: absolute;
    top: 140%;
    min-width: 180px;
    padding: 0.5rem 0;
    border-radius: 12px;
    background: var(--dropdown-bg, #fff);
    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.22);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.16s ease;
    z-index: 30;
  }

  .mix-header--rtl .mix-dropdown {
    right: 0;
  }

  .mix-header--ltr .mix-dropdown {
    left: 0;
  }

  .mix-dropdown--social {
    min-width: 210px;
  }

  .mix-dropdown__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .mix-dropdown__item {
    margin: 0;
  }

  .mix-dropdown__link {
    display: block;
    width: 100%;
    padding: 0.4rem 0.9rem;
    font-size: 0.9rem;
    text-align: start;
    background: none;
    border: none;
    color: var(--header-fg, #111);
    cursor: pointer;
    text-decoration: none;
  }

  .mix-dropdown__link:hover {
    color: var(--brand, #0fa99c);
  }

  /* MEGA MENUS */
  .mix-mega {
    position: absolute;
    top: 100%;
    margin-top: 0.5rem;
    z-index: 35;
    pointer-events: none;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  .mix-mega--rtl {
    direction: rtl;
    right: 2.5rem;
    left: auto;
  }

  .mix-mega--ltr {
    direction: ltr;
    left: 2.5rem;
    right: auto;
  }

  .mix-mega.is-open {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .mix-mega__inner {
    display: grid;
    grid-template-columns: minmax(180px, 220px) minmax(260px, 360px);
    background: var(--dropdown-bg, #fff);
    border-radius: 16px;
    box-shadow: 0 24px 50px rgba(0, 0, 0, 0.24);
    overflow: hidden;
  }

  .mix-mega__inner--single {
    grid-template-columns: 1fr;
  }

  .mix-mega__root-col {
    padding: 1.1rem 1.1rem 1.1rem 0.9rem;
    border-inline-end: 1px solid rgba(120, 130, 150, 0.25);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mix-mega__sub-col {
    padding: 1.1rem 1.25rem;
  }

  .mix-mega__root {
    border: none;
    background: none;
    cursor: pointer;
    padding: 0.35rem 0.4rem;
    font-size: 0.95rem;
    text-align: inherit;
    color: var(--header-fg, #111);
    position: relative;
  }

  .mix-mega__root.is-active {
    color: var(--brand, #0fa99c);
  }

  .mix-mega__root.is-active::after {
    content: "";
    position: absolute;
    top: 0.4rem;
    bottom: 0.4rem;
    inline-size: 2px;
    background: var(--brand, #0fa99c);
    inset-inline-end: 0;
  }

  .mix-mega__sub-group {
    display: none;
  }

  .mix-mega__sub-group.is-active {
    display: block;
  }

  .mix-mega__sub-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mix-mega__sub-item {
    margin: 0;
  }

  .mix-mega__sub-link {
    font-size: 0.95rem;
    text-decoration: none;
    color: var(--header-fg, #111);
  }

  .mix-mega__sub-link:hover {
    color: var(--brand, #0fa99c);
  }

  /* THEME DEPENDENT COLORS – از متغیرهای global استفاده می‌شود */
  html[data-theme="light"] .mix-header {
    --header-fg: #111111;
    --dropdown-bg: #ffffff;
  }

  html[data-theme="dark"] .mix-header {
    --header-fg: #f7f7f7;
    --dropdown-bg: #05070a;
  }
</style>
