---
// src/components/Header.astro

import { categories } from '../data/categories';
// social را به صورت ماژول کامل می‌گیریم که همه حالت‌های export را پوشش بدهیم
import * as socialModule from '../data/social';

// همیشه یک آرایه امن از لینک‌های سوشیال بساز
const socialItems =
  Array.isArray((socialModule as any).social)
    ? (socialModule as any).social
    : Array.isArray((socialModule as any).default)
      ? (socialModule as any).default
      : [];

const { lang = 'fa' } = Astro.props as { lang?: 'fa' | 'en' };

const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';

const root = `/${lang}`;
const catalogHref = lang === 'fa'
  ? '/docs/catalog-fa.pdf'
  : '/docs/catalog-en.pdf';

const aboutHref = `${root}/about/`;
const dealersHref = `${root}/dealers/`;
const productsRoot = `${root}/products/`;
const afterSalesRoot = `${root}/after-sales/`;

// متن‌ها
const t = isFa
  ? {
      products: 'محصولات',
      dealers: 'نمایندگی‌های مجاز',
      afterSales: 'خدمات پس از فروش',
      about: 'درباره ما',
      downloadCatalog: 'دانلود کاتالوگ',
      langLabel: 'فارسی',
      otherLangLabel: 'English',
      socialMenuLabel: '#',
    }
  : {
      products: 'Products',
      dealers: 'Dealers',
      afterSales: 'After-Sales',
      about: 'About-Us',
      downloadCatalog: 'Download Catalog',
      langLabel: 'English',
      otherLangLabel: 'فارسی',
      socialMenuLabel: '#',
    };

// صفحات خدمات پس از فروش
const afterSalesPages = isFa
  ? [
      {
        label: 'فرآیند رسیدگی به شکایات',
        href: `${afterSalesRoot}complaint-process/`,
      },
      {
        label: 'شرایط گارانتی محصولات میکس‌پلاس',
        href: `${afterSalesRoot}warranty-terms/`,
      },
      {
        label: 'درخواست نصب محصول',
        href: `${afterSalesRoot}installation-request/`,
      },
      {
        label: 'شکایت',
        href: `${afterSalesRoot}complaint/`,
      },
    ]
  : [
      {
        label: 'Complaint process',
        href: `${afterSalesRoot}complaint-process/`,
      },
      {
        label: 'Warranty terms',
        href: `${afterSalesRoot}warranty-terms/`,
      },
      {
        label: 'Installation request',
        href: `${afterSalesRoot}installation-request/`,
      },
      {
        label: 'Complaint',
        href: `${afterSalesRoot}complaint/`,
      },
    ];
---

<header class={`mix-header ${isFa ? 'mix-header--fa' : 'mix-header--en'}`}>
  <div class="mix-header__inner">
    {isFa ? (
      <>
        {/* FA – سمت راست لوگو: محصولات | نمایندگی‌ها | خدمات پس از فروش */}
        <nav class="mix-header__nav mix-header__nav--primary">
          <div class="mix-header__item mix-header__item--has-mega" data-menu="products">
            <button class="mix-header__link" type="button" data-trigger>
              {t.products}
            </button>
            <div class="mix-mega mix-mega--products" data-panel>
              <div class="mix-mega__col mix-mega__col--roots">
                {categories.map((cat) => (
                  <a
                    href={`${productsRoot}${cat.slug}/`}
                    class="mix-mega__root"
                    data-cat={cat.slug}
                  >
                    {isFa ? cat.nameFa : cat.nameEn}
                  </a>
                ))}
              </div>
              <div class="mix-mega__col mix-mega__col--subs" data-subs-container>
                {categories.map((cat) =>
                  cat.subs ? (
                    <div class="mix-mega__subs" data-subs-for={cat.slug}>
                      {cat.subs.map((sub) => (
                        <a
                          href={`${productsRoot}${cat.slug}/${sub.slug}/`}
                          class="mix-mega__sub"
                        >
                          {isFa ? sub.nameFa : sub.nameEn}
                        </a>
                      ))}
                    </div>
                  ) : (
                    <div class="mix-mega__subs" data-subs-for={cat.slug}>
                      <a
                        href={`${productsRoot}${cat.slug}/`}
                        class="mix-mega__sub mix-mega__sub--single"
                      >
                        {isFa ? cat.nameFa : cat.nameEn}
                      </a>
                    </div>
                  )
                )}
              </div>
            </div>
          </div>

          <a class="mix-header__link" href={dealersHref}>
            {t.dealers}
          </a>

          <div class="mix-header__item mix-header__item--has-mega" data-menu="after-sales">
            <button class="mix-header__link" type="button" data-trigger>
              {t.afterSales}
            </button>
            <div class="mix-mega mix-mega--aftersales" data-panel>
              <div class="mix-mega__col mix-mega__col--single">
                {afterSalesPages.map((item) => (
                  <a href={item.href} class="mix-mega__sub">
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </nav>

        {/* لوگو وسط */}
        <a href={root + '/'} class="mix-header__logo">
          <img
            src="/logos/logo.svg"
            alt="MixPlus"
            class="mix-header__logo-img mix-header__logo-img--light"
          />
          <img
            src="/logos/logo-dark.svg"
            alt="MixPlus"
            class="mix-header__logo-img mix-header__logo-img--dark"
          />
        </a>

        {/* FA – سمت چپ لوگو: سرچ | # | درباره ما | کاتالوگ | زبان | تم */}
        <nav class="mix-header__nav mix-header__nav--secondary">
          <button class="mix-header__icon-btn" type="button" aria-label="جستجو">
            <span class="mix-icon mix-icon--search" aria-hidden="true"></span>
          </button>

          <div class="mix-header__divider"></div>

          <div class="mix-header__item mix-header__item--has-dropdown" data-menu="social">
            <button
              class="mix-header__link mix-header__link--hash"
              type="button"
              data-trigger
              aria-haspopup="true"
              aria-expanded="false"
            >
              {t.socialMenuLabel}
            </button>
            <div class="mix-dropdown mix-dropdown--social" data-panel>
              <ul>
                {socialItems.map((item: any) => (
                  <li>
                    <a href={item.href} target="_blank" rel="noopener" aria-label={item.label}>
                      <span class="mix-dropdown__label">{item.label}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <div class="mix-header__divider"></div>

          <a class="mix-header__link" href={aboutHref}>
            {t.about}
          </a>

          <div class="mix-header__divider"></div>

          <a class="mix-header__link" href={catalogHref} target="_blank" rel="noopener">
            {t.downloadCatalog}
          </a>

          <div class="mix-header__divider"></div>

          <div class="mix-header__item mix-header__item--has-dropdown" data-menu="lang">
            <button
              class="mix-header__link"
              type="button"
              data-trigger
              aria-haspopup="true"
              aria-expanded="false"
            >
              {t.langLabel} ▼
            </button>
            <div class="mix-dropdown mix-dropdown--lang" data-panel>
              <a href={`/${otherLang}/`} class="mix-dropdown__lang">
                {t.otherLangLabel}
              </a>
            </div>
          </div>

          <div class="mix-header__divider"></div>

          <button
            class="mix-header__icon-btn"
            type="button"
            data-theme-toggle
            aria-label="Switch theme"
          >
            <span class="mix-icon mix-icon--theme" aria-hidden="true"></span>
          </button>
        </nav>
      </>
    ) : (
      <>
        {/* EN – left: Products | Dealers | After-Sales | About-Us */}
        <nav class="mix-header__nav mix-header__nav--primary">
          <div class="mix-header__item mix-header__item--has-mega" data-menu="products">
            <button class="mix-header__link" type="button" data-trigger>
              {t.products}
            </button>
            <div class="mix-mega mix-mega--products" data-panel>
              <div class="mix-mega__col mix-mega__col--roots">
                {categories.map((cat) => (
                  <a
                    href={`${productsRoot}${cat.slug}/`}
                    class="mix-mega__root"
                    data-cat={cat.slug}
                  >
                    {isFa ? cat.nameFa : cat.nameEn}
                  </a>
                ))}
              </div>
              <div class="mix-mega__col mix-mega__col--subs" data-subs-container>
                {categories.map((cat) =>
                  cat.subs ? (
                    <div class="mix-mega__subs" data-subs-for={cat.slug}>
                      {cat.subs.map((sub) => (
                        <a
                          href={`${productsRoot}${cat.slug}/${sub.slug}/`}
                          class="mix-mega__sub"
                        >
                          {isFa ? sub.nameFa : sub.nameEn}
                        </a>
                      ))}
                    </div>
                  ) : (
                    <div class="mix-mega__subs" data-subs-for={cat.slug}>
                      <a
                        href={`${productsRoot}${cat.slug}/`}
                        class="mix-mega__sub mix-mega__sub--single"
                      >
                        {isFa ? cat.nameFa : cat.nameEn}
                      </a>
                    </div>
                  )
                )}
              </div>
            </div>
          </div>

          <a class="mix-header__link" href={dealersHref}>
            {t.dealers}
          </a>

          <div class="mix-header__item mix-header__item--has-mega" data-menu="after-sales">
            <button class="mix-header__link" type="button" data-trigger>
              {t.afterSales}
            </button>
            <div class="mix-mega mix-mega--aftersales" data-panel>
              <div class="mix-mega__col mix-mega__col--single">
                {afterSalesPages.map((item) => (
                  <a href={item.href} class="mix-mega__sub">
                    {item.label}
                  </a>
                ))}
              </div>
            </div>
          </div>

          <a class="mix-header__link" href={aboutHref}>
            {t.about}
          </a>
        </nav>

        {/* logo center */}
        <a href={root + '/'} class="mix-header__logo">
          <img
            src="/logos/logo.svg"
            alt="MixPlus"
            class="mix-header__logo-img mix-header__logo-img--light"
          />
          <img
            src="/logos/logo-dark.svg"
            alt="MixPlus"
            class="mix-header__logo-img mix-header__logo-img--dark"
          />
        </a>

        {/* EN – right: search | # | Download | English ▼ | theme */}
        <nav class="mix-header__nav mix-header__nav--secondary">
          <button class="mix-header__icon-btn" type="button" aria-label="Search">
            <span class="mix-icon mix-icon--search" aria-hidden="true"></span>
          </button>

          <div class="mix-header__divider"></div>

          <div class="mix-header__item mix-header__item--has-dropdown" data-menu="social">
            <button
              class="mix-header__link mix-header__link--hash"
              type="button"
              data-trigger
              aria-haspopup="true"
              aria-expanded="false"
            >
              {t.socialMenuLabel}
            </button>
            <div class="mix-dropdown mix-dropdown--social" data-panel>
              <ul>
                {socialItems.map((item: any) => (
                  <li>
                    <a href={item.href} target="_blank" rel="noopener" aria-label={item.label}>
                      <span class="mix-dropdown__label">{item.label}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <div class="mix-header__divider"></div>

          <a class="mix-header__link" href={catalogHref} target="_blank" rel="noopener">
            {t.downloadCatalog}
          </a>

          <div class="mix-header__divider"></div>

          <div class="mix-header__item mix-header__item--has-dropdown" data-menu="lang">
            <button
              class="mix-header__link"
              type="button"
              data-trigger
              aria-haspopup="true"
              aria-expanded="false"
            >
              {t.langLabel} ▼
            </button>
            <div class="mix-dropdown mix-dropdown--lang" data-panel>
              <a href={`/${otherLang}/`} class="mix-dropdown__lang">
                {t.otherLangLabel}
              </a>
            </div>
          </div>

          <div class="mix-header__divider"></div>

          <button
            class="mix-header__icon-btn"
            type="button"
            data-theme-toggle
            aria-label="Switch theme"
          >
            <span class="mix-icon mix-icon--theme" aria-hidden="true"></span>
          </button>
        </nav>
      </>
    )}
  </div>
</header>

<script>
  const HOVER_DELAY = 220;

  function setupHoverMenus() {
    const menuGroups = document.querySelectorAll('[data-menu]');
    menuGroups.forEach((group) => {
      let openTimer = null;
      let closeTimer = null;
      const trigger = group.querySelector('[data-trigger]');
      const panel = group.querySelector('[data-panel]');

      if (!trigger || !panel) return;

      const open = () => {
        clearTimeout(closeTimer);
        openTimer = setTimeout(() => {
          group.classList.add('is-open');
        }, HOVER_DELAY);
      };

      const close = () => {
        clearTimeout(openTimer);
        closeTimer = setTimeout(() => {
          group.classList.remove('is-open');
        }, HOVER_DELAY);
      };

      trigger.addEventListener('mouseenter', open);
      trigger.addEventListener('mouseleave', close);
      panel.addEventListener('mouseenter', open);
      panel.addEventListener('mouseleave', close);

      trigger.addEventListener('click', (e) => {
        e.preventDefault();
        group.classList.toggle('is-open');
      });
    });

    // فعال‌سازی ساب‌کتگوری‌های مگامنو محصولات
    const roots = document.querySelectorAll('.mix-mega__root');
    const subsContainers = document.querySelectorAll('.mix-mega__subs');

    function showSubs(slug) {
      subsContainers.forEach((el) => {
        if (el.getAttribute('data-subs-for') === slug) {
          el.classList.add('is-active');
        } else {
          el.classList.remove('is-active');
        }
      });
      roots.forEach((el) => {
        if (el.getAttribute('data-cat') === slug) {
          el.classList.add('is-active');
        } else {
          el.classList.remove('is-active');
        }
      });
    }

    if (roots.length) {
      const firstSlug = roots[0].getAttribute('data-cat');
      if (firstSlug) showSubs(firstSlug);

      roots.forEach((root) => {
        root.addEventListener('mouseenter', () => {
          const slug = root.getAttribute('data-cat');
          if (slug) showSubs(slug);
        });
        root.addEventListener('focus', () => {
          const slug = root.getAttribute('data-cat');
          if (slug) showSubs(slug);
        });
      });
    }

    // تم لایت/دارک
    const THEME_KEY = 'mix_theme';
    const themeToggle = document.querySelector('[data-theme-toggle]');
    if (themeToggle) {
      const root = document.documentElement;
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'dark' || saved === 'light') {
        root.dataset.theme = saved;
      }
      themeToggle.addEventListener('click', () => {
        const current = root.dataset.theme === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        root.dataset.theme = next;
        localStorage.setItem(THEME_KEY, next);
      });
    }

    const header = document.querySelector('.mix-header');
    if (header) {
      const onScroll = () => {
        if (window.scrollY > 10) {
          header.classList.add('mix-header--scrolled');
        } else {
          header.classList.remove('mix-header--scrolled');
        }
      };
      onScroll();
      window.addEventListener('scroll', onScroll, { passive: true });
    }
  }

  if (typeof window !== 'undefined') {
    window.addEventListener('DOMContentLoaded', setupHoverMenus);
  }
</script>

<style>
  .mix-header {
    position: sticky;
    top: 0;
    z-index: 40;
    backdrop-filter: blur(10px);
    background: rgba(15, 15, 20, 0.4);
    border-bottom: 1px solid transparent;
    transition: background 160ms ease, border-color 160ms ease;
  }

  .mix-header--scrolled {
    background: var(--card, rgba(245, 245, 245, 0.96));
    border-bottom-color: var(--stroke, rgba(0, 0, 0, 0.08));
  }

  html[data-theme='dark'] .mix-header {
    background: rgba(10, 12, 16, 0.65);
  }

  html[data-theme='dark'] .mix-header--scrolled {
    background: rgba(10, 12, 16, 0.98);
  }

  .mix-header__inner {
    max-width: 1440px;
    margin-inline: auto;
    padding: 0.6rem 2.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 2.5rem;
    font-family: var(--font-fa, inherit);
    font-size: 0.95rem;
    line-height: 1;
  }

  .mix-header--en .mix-header__inner {
    direction: ltr;
    font-family: var(--font-en, system-ui);
  }

  .mix-header--fa .mix-header__inner {
    direction: rtl;
  }

  .mix-header__nav {
    display: inline-flex;
    align-items: center;
    gap: 1.75rem;
    white-space: nowrap;
  }

  .mix-header__nav--secondary {
    font-size: 0.9rem;
  }

  .mix-header__logo {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding-inline: 2.5rem;
  }

  .mix-header__logo-img {
    height: 32px;
    display: block;
  }

  .mix-header__logo-img--dark {
    display: none;
  }

  html[data-theme='dark'] .mix-header__logo-img--light {
    display: none;
  }

  html[data-theme='dark'] .mix-header__logo-img--dark {
    display: block;
  }

  .mix-header__link {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    font: inherit;
    color: var(--fg, #111);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    text-decoration: none;
    position: relative;
  }

  html[data-theme='dark'] .mix-header__link {
    color: #f7f7f8;
  }

  .mix-header__link:hover,
  .mix-header__link:focus-visible {
    color: var(--brand, #0fa99c);
  }

  .mix-header__link--hash {
    font-weight: 700;
  }

  .mix-header__divider {
    width: 1px;
    height: 1.4rem;
    background: rgba(0, 0, 0, 0.16);
  }

  html[data-theme='dark'] .mix-header__divider {
    background: rgba(255, 255, 255, 0.16);
  }

  .mix-header__icon-btn {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .mix-icon {
    width: 18px;
    height: 18px;
    display: inline-block;
    position: relative;
  }

  .mix-icon--search::before {
    content: '';
    position: absolute;
    inset: 3px;
    border-radius: 50%;
    border: 2px solid currentColor;
  }

  .mix-icon--search::after {
    content: '';
    position: absolute;
    right: -1px;
    bottom: -1px;
    width: 7px;
    height: 2px;
    border-radius: 999px;
    background: currentColor;
    transform: rotate(45deg);
  }

  .mix-icon--theme::before {
    content: '☾';
    font-size: 14px;
    line-height: 1;
  }

  html[data-theme='dark'] .mix-icon--theme::before {
    content: '☀';
  }

  .mix-header__item--has-mega {
    position: relative;
  }

  .mix-mega {
    position: absolute;
    inset-inline-start: 0;
    top: 100%;
    margin-top: 0.9rem;
    min-width: 420px;
    background: var(--card, #fff);
    border-radius: 14px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.28);
    padding: 1.25rem 1.5rem;
    display: none;
    gap: 2rem;
    z-index: 50;
  }

  .mix-header--en .mix-mega {
    direction: ltr;
  }

  .mix-header--fa .mix-mega {
    direction: rtl;
  }

  html[data-theme='dark'] .mix-mega {
    background: #10141b;
  }

  .mix-header__item.is-open > .mix-mega {
    display: grid;
    grid-template-columns: minmax(140px, 1fr) minmax(160px, 1fr);
  }

  .mix-mega__col--single {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .mix-mega__root {
    display: block;
    padding-block: 0.4rem;
    padding-inline-end: 0.75rem;
    position: relative;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }

  .mix-mega__root.is-active {
    color: var(--brand, #0fa99c);
    font-weight: 700;
  }

  .mix-mega__root.is-active::before {
    content: '';
    position: absolute;
    inset-inline-end: 0;
    top: 0.3rem;
    bottom: 0.3rem;
    width: 3px;
    border-radius: 999px;
    background: var(--brand, #0fa99c);
  }

  .mix-mega__subs {
    display: none;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mix-mega__subs.is-active {
    display: flex;
  }

  .mix-mega__sub {
    text-decoration: none;
    color: inherit;
    padding-block: 0.25rem;
  }

  .mix-mega__sub:hover,
  .mix-mega__sub:focus-visible {
    color: var(--brand, #0fa99c);
  }

  .mix-dropdown {
    position: absolute;
    top: 100%;
    margin-top: 0.8rem;
    inset-inline-start: 0;
    min-width: 180px;
    padding: 0.75rem 1rem;
    border-radius: 14px;
    background: var(--card, #fff);
    box-shadow: 0 16px 38px rgba(0, 0, 0, 0.22);
    display: none;
    z-index: 60;
  }

  .mix-header--en .mix-dropdown {
    direction: ltr;
  }

  .mix-header--fa .mix-dropdown {
    direction: rtl;
  }

  html[data-theme='dark'] .mix-dropdown {
    background: #10141b;
  }

  .mix-header__item.is-open > .mix-dropdown {
    display: block;
  }

  .mix-dropdown--social ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .mix-dropdown--social a {
    text-decoration: none;
    color: inherit;
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
  }

  .mix-dropdown__label {
    font-size: 0.9rem;
  }

  .mix-dropdown__lang {
    text-decoration: none;
    color: inherit;
    font-size: 0.9rem;
  }

  .mix-dropdown__lang:hover,
  .mix-dropdown__lang:focus-visible {
    color: var(--brand, #0fa99c);
  }

  @media (max-width: 1120px) {
    .mix-header__inner {
      padding-inline: 1.25rem;
      gap: 1.5rem;
    }

    .mix-header__nav {
      gap: 1.1rem;
      font-size: 0.9rem;
    }

    .mix-header__logo {
      padding-inline: 1.5rem;
    }
  }

  @media (max-width: 880px) {
    .mix-header__inner {
      padding-inline: 1rem;
    }
  }
</style>
