---
import { categories } from '../data/categories';
import { social } from '../data/social';

const { lang = 'fa' } = Astro.props;
const isFa = lang === 'fa';
const otherLang = isFa ? 'en' : 'fa';

const downloadHref = `/public/docs/catalog-${lang}.pdf`.replace('/public','');

const roots = [
  { slug: 'hob',  fa: 'Ø§Ø¬Ø§Ù‚ Ú¯Ø§Ø²',        en: 'Hob' },
  { slug: 'sink', fa: 'Ø³ÛŒÙ†Ú© Ø¸Ø±Ùâ€ŒØ´ÙˆÛŒÛŒ',   en: 'Sink' },
  { slug: 'hood', fa: 'Ù‡ÙˆØ¯',             en: 'Hood' },
  { slug: 'oven', fa: 'ÙØ±',              en: 'Oven' },
];
---

<header class="hdr" dir={isFa ? 'rtl' : 'ltr'}>
  <div class="container hdr__row">

    {/** Ú¯Ø±ÙˆÙ‡ Â«Ù…Ø­ØµÙˆÙ„Ø§Øª / Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ / Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´Â» */}
    <nav class={`nav ${isFa ? 'slot-3' : 'slot-1'}`} aria-label="primary">
      {isFa ? (
        <>
          {/** Ø¯Ø± RTL ØªØ±ØªÛŒØ¨ DOM = ØªØ±ØªÛŒØ¨ Ø¨ØµØ±ÛŒ Ø§Ø² Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾
              Ù¾Ø³ Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø¨Ø´Ù‡: Ù…Ø­ØµÙˆÙ„Ø§Øª | Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø² | Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´
          */}
          {/** Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù…Ú¯Ø§Ù…Ù†Ùˆ) â€“ Ø±Ø§Ø³Øªâ€ŒØªØ±ÛŒÙ† Ø¢ÛŒØªÙ… */}
          <div class="mega mega--products" tabindex="0" aria-haspopup="true">
            <a class="link">Ù…Ø­ØµÙˆÙ„Ø§Øª</a>
            <div class="bridge"></div>
            <div class="panel panel--products">
              <div class="cols">
                <ul class="roots" id="roots-fa">
                  {roots.map(r => (
                    <li>
                      <a class="root" data-slug={r.slug} href={`/${lang}/products/${r.slug}/`}>
                        {r.fa}
                      </a>
                    </li>
                  ))}
                </ul>
                <div class="subs" id="subs-fa">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug: 'built-in', nameFa: 'ÙØ± ØªÙˆÚ©Ø§Ø±', nameEn: 'Built-in' }];
                    return (
                      <ul data-for={r.slug}>
                        {subs.map(s => (
                          <li>
                            <a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{s.nameFa}</a>
                          </li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/dealers/`}>Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø§Ø²</a>
          <span class="pipe">|</span>

          {/** Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´ (Ù…Ú¯Ø§Ù…Ù†Ùˆ Ù„ÛŒØ³ØªÛŒ) â€“ Ú†Ù¾ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ */}
          <div class="mega" tabindex="0" aria-haspopup="true">
            <a class="link">Ø®Ø¯Ù…Ø§Øª Ù¾Ø³ Ø§Ø² ÙØ±ÙˆØ´</a>
            <div class="bridge"></div>
            <div class="panel panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>ÙØ±Ø¢ÛŒÙ†Ø¯ Ø±Ø³ÛŒØ¯Ú¯ÛŒ Ø¨Ù‡ Ø´Ú©Ø§ÛŒØ§Øª</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÛŒÚ©Ø³â€ŒÙ¾Ù„Ø§Ø³</a>
              <a href={`/${lang}/after-sales/installation-request/`}>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†ØµØ¨ Ù…Ø­ØµÙˆÙ„</a>
              <a href={`/${lang}/after-sales/complaint/`}>Ø´Ú©Ø§ÛŒØª</a>
            </div>
          </div>
        </>
      ) : (
        <>
          {/** EN: Products | Dealers | After-Sales | About-Us (Ù‡Ù…ÙˆÙ† Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø§Ù„Ø§Ù† Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯Ù‡) */}
          <div class="mega mega--products" tabindex="0" aria-haspopup="true">
            <a class="link">Products</a>
            <div class="bridge"></div>
            <div class="panel panel--products">
              <div class="cols">
                <ul class="roots" id="roots-en">
                  {roots.map(r => (
                    <li>
                      <a class="root" data-slug={r.slug} href={`/${lang}/products/${r.slug}/`}>
                        {r.en}
                      </a>
                    </li>
                  ))}
                </ul>
                <div class="subs" id="subs-en">
                  {roots.map(r => {
                    const cat = categories.find(c => c.slug === r.slug);
                    const subs = (cat?.subs?.length)
                      ? cat!.subs
                      : [{ slug: 'built-in', nameFa: 'ÙØ± ØªÙˆÚ©Ø§Ø±', nameEn: 'Built-in' }];
                    return (
                      <ul data-for={r.slug}>
                        {subs.map(s => (
                          <li>
                            <a href={`/${lang}/products/${r.slug}/${s.slug}/`}>{s.nameEn}</a>
                          </li>
                        ))}
                      </ul>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/dealers/`}>Dealers</a>
          <span class="pipe">|</span>

          <div class="mega" tabindex="0" aria-haspopup="true">
            <a class="link">After-Sales</a>
            <div class="bridge"></div>
            <div class="panel panel--list">
              <a href={`/${lang}/after-sales/complaint-process/`}>Complaint process</a>
              <a href={`/${lang}/after-sales/warranty-terms/`}>Warranty terms</a>
              <a href={`/${lang}/after-sales/installation-request/`}>Installation request</a>
              <a href={`/${lang}/after-sales/complaint/`}>Complaint</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/about/`}>About-Us</a>
        </>
      )}
    </nav>

    {/** Ù„ÙˆÚ¯Ùˆ ÙˆØ³Ø· Ø¨Ø§ ÙØ§ØµÙ„Ù‡â€ŒÛŒ ØªÙ†ÙØ³ÛŒ Ø¯Ùˆ Ø·Ø±Ù */}
    <a class="brand slot-2" href={`/${lang}/`} aria-label="MixPlus">
      <brand-logo width="120" height="30"></brand-logo>
    </a>

    {/** Ú¯Ø±ÙˆÙ‡ Ø¯ÙˆÙ…: Ø³Ù…Øª Ú†Ù¾ Ø¯Ø± FAØŒ Ø³Ù…Øª Ø±Ø§Ø³Øª Ø¯Ø± EN */}
    <nav class={`nav ${isFa ? 'slot-1' : 'slot-3'}`} aria-label="secondary">
      {isFa ? (
        <>
          {/** ğŸŒ™ | ÙØ§Ø±Ø³ÛŒ â–¼ | Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§ØªØ§Ù„ÙˆÚ¯ | Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ | # | ğŸ” */}
          <theme-switch class="link" title="Toggle theme"></theme-switch>
          <span class="pipe">|</span>

          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <a class="link">ÙØ§Ø±Ø³ÛŒ â–¼</a>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={`/${otherLang}/`}>English</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={downloadHref} download>Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§ØªØ§Ù„ÙˆÚ¯</a>

          <span class="pipe">|</span>
          <a class="link" href={`/${lang}/about/`}>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>

          <span class="pipe">|</span>
          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <a class="link">#</a>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <button class="link icon" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none" />
              <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
          </button>
        </>
      ) : (
        <>
          <button class="link icon" aria-label="Search" title="Search" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" fill="none" />
              <path d="M20 20l-3.5-3.5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
          </button>

          <span class="pipe">|</span>
          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <a class="link">#</a>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={social.instagram} target="_blank" rel="noopener">Instagram</a>
              <a href={social.aparat}   target="_blank" rel="noopener">Aparat</a>
              <a href={social.youtube}  target="_blank" rel="noopener">YouTube</a>
              <a href={social.linkedin} target="_blank" rel="noopener">LinkedIn</a>
              <a href={social.telegram} target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <a class="link" href={downloadHref} download>Download Catalog</a>

          <span class="pipe">|</span>
          <div class="mega tiny" tabindex="0" aria-haspopup="true">
            <a class="link">English â–¼</a>
            <div class="bridge"></div>
            <div class="panel panel--tiny">
              <a href={`/${otherLang}/`}>Farsi</a>
            </div>
          </div>

          <span class="pipe">|</span>
          <theme-switch class="link" title="Toggle theme"></theme-switch>
        </>
      )}
    </nav>
  </div>
</header>

<style>
/* Ù‡Ø¯Ø± Ø´ÙØ§Ù + Ø¨Ù„ÙˆØ± */
.hdr{
  position:sticky;
  top:0;
  z-index:60;
  border-bottom:1px solid transparent;
  background:rgba(255,255,255,.48);
  backdrop-filter:blur(10px);
}
html:not(.is-light) .hdr{
  background:rgba(16,20,26,.28);
}
html.scrolled .hdr{
  background:var(--card);
  border-bottom-color:var(--stroke);
  backdrop-filter:none;
}

/* Ú†ÛŒÙ†Ø´ Ú©Ù„ÛŒ */
.hdr__row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  height:68px;
}
.slot-1{order:1}
.slot-2{order:2}
.slot-3{order:3}
.nav{
  display:flex;
  align-items:center;
  gap:12px; /* Ú©Ù…ÛŒ Ù…ØªØ±Ø§Ú©Ù…â€ŒØªØ± */
  white-space:nowrap;
}

/* Ù„ÙˆÚ¯Ùˆ Ø¨Ø§ ÙØ§ØµÙ„Ù‡â€ŒÛŒ ØªÙ†ÙØ³ÛŒ Ø¨ÛŒØ´ØªØ± */
.brand{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:68px;
  margin-inline:72px;
}

/* Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ */
.link{
  all:unset;
  cursor:pointer;
  font-weight:800;
  color:inherit;
  text-decoration:none;
}
.link:hover{
  color:var(--brand);
  text-decoration:none;
}
.icon svg{
  display:block;
  opacity:.9;
}
.pipe{
  opacity:.5;
}

/* Ù…Ú¯Ø§Ù…Ù†Ùˆ + hover-intent */
.bridge{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  height:12px;
}
.mega{
  position:relative;
}
.panel{
  position:absolute;
  top:calc(100% + 6px);
  inset-inline-start:0;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:14px;
  box-shadow:0 12px 32px rgba(0,0,0,.18);
  padding:12px;
  opacity:0;
  transform:translateY(6px);
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
}
/* Ù¾Ù†Ù„â€ŒÙ‡Ø§ Ø¯Ø± Ø­Ø§Ù„Øª RTL Ø§Ø² Ø³Ù…Øª Ø±Ø§Ø³Øª Ú†Ø³Ø¨ÛŒØ¯Ù‡ Ø¨Ø´Ù† ØªØ§ Ø§Ø² ØµÙØ­Ù‡ Ù†Ø²Ù†Ù† Ø¨ÛŒØ±ÙˆÙ† */
.hdr[dir="rtl"] .panel{
  inset-inline-start:auto;
  inset-inline-end:0;
}

.mega:hover .panel,
.mega:focus-within .panel{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}
.panel--tiny{
  min-width:140px;
}
.panel--list{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:280px;
}
.panel a{
  color:inherit;
  text-decoration:none;
}
.panel a:hover{
  color:var(--brand);
  text-decoration:none;
}

/* Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡ */
.panel--products{
  padding:10px;
}
.cols{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.roots{
  list-style:none;
  margin:0;
  padding:6px;
  border-inline-end:1px solid var(--stroke);
  min-width:240px;
}
.root{
  display:block;
  padding:10px 12px;
  border-radius:10px;
  font-weight:800;
  color:inherit;
}
.root:hover{
  color:var(--brand);
}
.subs > ul{
  list-style:none;
  margin:0;
  padding:6px;
  min-width:240px;
}
.subs a{
  display:block;
  padding:8px 12px;
  border-radius:10px;
  color:inherit;
}
.subs a:hover{
  color:var(--brand);
}
</style>

<script>
/* ØªÙ… Ùˆ Ù„ÙˆÚ¯Ùˆ */
const KEY = 'mix_theme';
const html = document.documentElement;
function applyTheme(v){ html.classList.toggle('is-light', v === 'light'); }
applyTheme(localStorage.getItem(KEY) || 'light');

customElements.define('theme-switch', class extends HTMLElement{
  connectedCallback(){
    this.setAttribute('role','button');
    this.style.userSelect = 'none';
    this.render();
    this.addEventListener('click', () => {
      const now = html.classList.contains('is-light') ? 'dark' : 'light';
      localStorage.setItem(KEY, now);
      applyTheme(now);
      this.render();
    });
  }
  render(){
    this.textContent = html.classList.contains('is-light') ? 'â˜¾' : 'â˜€ï¸';
  }
});

customElements.define('brand-logo', class extends HTMLElement{
  static get observedAttributes(){ return ['width','height']; }
  connectedCallback(){
    this.img = document.createElement('img');
    this.img.alt = 'MixPlus logo';
    this.appendChild(this.img);
    this._size();
    this._update();
    const mo = new MutationObserver(() => this._update());
    mo.observe(document.documentElement, { attributes:true, attributeFilter:['class'] });
    this._mo = mo;
  }
  disconnectedCallback(){ this._mo?.disconnect?.(); }
  attributeChangedCallback(){ this._size(); }
  _size(){
    const w = this.getAttribute('width') || '120';
    const h = this.getAttribute('height') || '30';
    this.img.width = +w;
    this.img.height = +h;
  }
  _update(){
    const light = html.classList.contains('is-light');
    this.img.src = light ? '/logos/logo-dark.svg' : '/logos/logo.svg';
  }
});

/* Ø§Ø³Ú©Ø±ÙˆÙ„ */
const onScroll = () => {
  document.documentElement.classList.toggle('scrolled', window.scrollY > 6);
};
onScroll();
addEventListener('scroll', onScroll);

/* hover-intent Ù…Ú¯Ø§Ù…Ù†Ùˆ */
document.querySelectorAll('.mega').forEach(el => {
  let t = null;
  const D = 650;
  const open = () => el.classList.add('open');
  const close = () => el.classList.remove('open');
  const delay = () => { t = setTimeout(close, D); };
  const cancel = () => { if (t){ clearTimeout(t); t = null; } };

  el.addEventListener('mouseenter', () => { cancel(); open(); });
  el.addEventListener('mouseleave', delay);
  el.addEventListener('focusin', () => { cancel(); open(); });
  el.addEventListener('focusout', delay);

  el.querySelectorAll('.bridge,.panel').forEach(n => {
    n.addEventListener('mouseenter', cancel);
    n.addEventListener('mouseleave', delay);
  });
});

/* Ù…Ø­ØµÙˆÙ„Ø§Øª: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¨â€ŒÚ©ØªÚ¯ÙˆØ±ÛŒâ€ŒÙ‡Ø§ Ø¯Ø± Ù‡Ø± Ø¯Ùˆ Ø²Ø¨Ø§Ù† */
function wireProducts(rootsId, subsId){
  const roots = document.getElementById(rootsId);
  const subs = document.getElementById(subsId);
  if (!roots || !subs) return;

  const show = slug => {
    subs.querySelectorAll('ul').forEach(u => {
      u.style.display = (u.dataset.for === slug) ? 'block' : 'none';
    });
  };

  show('hob'); // Ù¾ÛŒØ´â€ŒÙØ±Ø¶

  roots.addEventListener('mouseenter', e => {
    const a = e.target.closest('.root');
    if (a && a.dataset.slug) show(a.dataset.slug);
  }, true);
}
wireProducts('roots-fa','subs-fa');
wireProducts('roots-en','subs-en');
</script>
